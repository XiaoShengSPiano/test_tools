# SPMIDæ•°æ®åˆ†ææµç¨‹æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°SPMIDï¼ˆé’¢ç´æ•°æ®ï¼‰åˆ†æç³»ç»Ÿçš„å®Œæ•´æµç¨‹ï¼Œä»æ–‡ä»¶ä¸Šä¼ ã€æ•°æ®è§£æã€è¿‡æ»¤ã€åŒ¹é…ã€å¼‚å¸¸æ£€æµ‹åˆ°æœ€ç»ˆUIå±•ç¤ºçš„å…¨é“¾è·¯å®ç°ã€‚ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œç¡®ä¿æ•°æ®å¤„ç†çš„å‡†ç¡®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## å¯è§†åŒ–æ€»è§ˆ

###### ç³»ç»Ÿæ¶æ„å›¾

**æ¶æ„è¯´æ˜**ï¼š

ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»åº•å±‚åˆ°é¡¶å±‚ä¾æ¬¡ä¸ºæ•°æ®å±‚ï¼ˆData Layerï¼‰ã€SPMIDåˆ†æå±‚ï¼ˆSPMID Analysis Layerï¼‰ã€åç«¯å±‚ï¼ˆBackend Layerï¼‰å’Œç”¨æˆ·ç•Œé¢å±‚ï¼ˆUI Layerï¼‰ã€‚æ•°æ®å±‚è´Ÿè´£SPMIDæ–‡ä»¶çš„äºŒè¿›åˆ¶è§£æï¼Œé€šè¿‡SPMidReaderè¯»å–æ–‡ä»¶ç»“æ„ï¼Œè§£æå‡ºNoteå¯¹è±¡ï¼ˆåŒ…å«offsetã€é”®IDã€hammersåºåˆ—ã€after_touchåºåˆ—ç­‰ï¼‰ï¼Œå¹¶æ‰§è¡Œé”¤é€Ÿé˜ˆå€¼æ£€æŸ¥ä»¥è¯†åˆ«ä¸å‘å£°éŸ³ç¬¦ã€‚SPMIDåˆ†æå±‚æ˜¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼ŒåŒ…å«å››ä¸ªå…³é”®ç»„ä»¶ï¼šSPMIDAnalyzerä½œä¸ºæ€»åè°ƒå™¨ï¼Œè´Ÿè´£æ•´ä¸ªåˆ†ææµç¨‹çš„ç¼–æ’ï¼›DataFilterè´Ÿè´£è¿‡æ»¤æ— æ•ˆéŸ³ç¬¦ï¼ˆç©ºæ•°æ®ã€ä¸å‘å£°ã€æŒç»­æ—¶é—´è¿‡çŸ­ç­‰ï¼‰ï¼›NoteMatcherå®ç°åŸºäºæ—¶é—´è¯¯å·®çš„è´ªå¿ƒåŒ¹é…ç®—æ³•ï¼Œç¡®ä¿ä¸€å¯¹ä¸€åŒ¹é…ï¼›ErrorDetectorè¯†åˆ«ä¸¢é”¤å’Œå¤šé”¤é—®é¢˜ã€‚åç«¯å±‚æä¾›ä¸šåŠ¡æœåŠ¡æ¥å£ï¼ŒPianoAnalysisBackendæ˜¯ä¸»è¦å…¥å£ï¼Œæ¥æ”¶UIè¯·æ±‚å¹¶åè°ƒå„åˆ†æç»„ä»¶ï¼ŒPlotGeneratorè´Ÿè´£ç”Ÿæˆç€‘å¸ƒå›¾ç­‰å¯è§†åŒ–å›¾è¡¨ï¼ŒTableDataGeneratorè´Ÿè´£ç”Ÿæˆå„ç±»è¡¨æ ¼æ•°æ®ï¼ŒDataManagerç®¡ç†ä¼šè¯çŠ¶æ€å’Œä¸´æ—¶æ–‡ä»¶ã€‚UIå±‚ä½¿ç”¨Dashæ¡†æ¶æ„å»ºWebç•Œé¢ï¼ŒLayout Componentså®šä¹‰é¡µé¢å¸ƒå±€å’Œç»„ä»¶ï¼ŒCallbackså¤„ç†ç”¨æˆ·äº¤äº’å’Œé¡µé¢æ›´æ–°ã€‚æ•´ä¸ªç³»ç»Ÿéµå¾ªå•å‘æ•°æ®æµï¼šç”¨æˆ·æ“ä½œé€šè¿‡UIå±‚è§¦å‘ï¼Œåç«¯å±‚åè°ƒå„åˆ†ææ¨¡å—å¤„ç†æ•°æ®ï¼Œæœ€ç»ˆå°†ç»“æœè¿”å›UIå±‚å±•ç¤ºã€‚æ‰€æœ‰æ—¶é—´æ•°æ®åœ¨å†…éƒ¨ç»Ÿä¸€ä½¿ç”¨0.1mså•ä½ï¼Œä»…åœ¨UIå±•ç¤ºæ—¶è½¬æ¢ä¸ºmsï¼Œç¡®ä¿è®¡ç®—ç²¾åº¦å’Œæ˜¾ç¤ºå‹å¥½æ€§çš„å¹³è¡¡ã€‚

```mermaid
flowchart LR
  subgraph UI[UI Layer]
    UI1[Dash Layout\nui/layout_components.py]
    UI2[Callbacks\nui/callbacks.py]
  end

  subgraph BE[Backend Layer]
    BE1[PianoAnalysisBackend\nbackend/piano_analysis_backend.py]
    BE2[PlotGenerator\nbackend/plot_generator.py]
    BE3[TableDataGenerator\nbackend/table_data_generator.py]
  end

  subgraph SPMID[SPMID Analysis Layer]
    A1[SPMIDAnalyzer\nspmid/spmid_analyzer.py]
    A2[DataFilter\nspmid/data_filter.py]
    A3[NoteMatcher\nspmid/note_matcher.py]
    A4[ErrorDetector\nspmid/error_detector.py]
  end

  subgraph DATA[Data Layer]
    D1[SPMidReader\nspmid/spmid_reader.py]
    D2[Note Objects]
  end

  UI1 --> UI2
  UI2 --> BE1
  BE1 --> D1
  D1 --> D2
  BE1 --> A1
  A1 --> A2
  A1 --> A3
  A1 --> A4
  BE1 --> BE2
  BE1 --> BE3
  BE2 --> UI1
  BE3 --> UI1
```

### ç«¯åˆ°ç«¯æ—¶åºå›¾

**æ—¶åºæµç¨‹è¯¦ç»†è¯´æ˜**ï¼š

æ•´ä¸ªç³»ç»Ÿä»ç”¨æˆ·ä¸Šä¼ SPMIDæ–‡ä»¶åˆ°æœ€ç»ˆå±•ç¤ºåˆ†æç»“æœï¼Œç»å†äº†å®Œæ•´çš„ç«¯åˆ°ç«¯å¤„ç†æµç¨‹ã€‚é¦–å…ˆï¼Œç”¨æˆ·é€šè¿‡Dash Webç•Œé¢ä¸Šä¼ æˆ–é€‰æ‹©SPMIDæ–‡ä»¶ï¼Œè§¦å‘UIå±‚çš„æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ã€‚UIå±‚å°†æ–‡ä»¶æ•°æ®ï¼ˆspmid_bytesï¼‰ä¼ é€’ç»™åç«¯å±‚çš„PianoAnalysisBackendï¼Œè°ƒç”¨load_spmid_dataæ–¹æ³•ã€‚åç«¯é¦–å…ˆåˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜ä¸Šä¼ çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åè°ƒç”¨SPMidReaderä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚SPMidReaderè§£æSPMIDæ–‡ä»¶çš„äºŒè¿›åˆ¶ç»“æ„ï¼ˆæ–‡ä»¶å¤´ã€ç´¢å¼•å—ã€NOTEå—ç­‰ï¼‰ï¼Œæ„é€ Noteå¯¹è±¡åˆ—è¡¨ï¼Œæ¯ä¸ªNoteåŒ…å«offsetï¼ˆæ—¶é—´åç§»é‡ï¼‰ã€é”®IDã€hammersåºåˆ—ï¼ˆé”¤é€Ÿæ•°æ®ï¼Œindexä¸ºæ—¶é—´æˆ³ï¼Œvalueä¸ºé”¤é€Ÿå€¼ï¼‰ã€after_touchåºåˆ—ï¼ˆè§¦åæ•°æ®ï¼Œindexä¸ºæ—¶é—´æˆ³ï¼Œvalueä¸ºæŒ‰é”®æ·±åº¦ï¼‰ç­‰ã€‚è¯»å–å®Œæˆåï¼Œè¿”å›ä¸¤æ¡éŸ³è½¨çš„æ•°æ®ï¼šrecord_dataï¼ˆå½•åˆ¶æ•°æ®ï¼Œå®é™…æ¼”å¥ï¼‰å’Œreplay_dataï¼ˆæ’­æ”¾æ•°æ®ï¼ŒMIDIå›æ”¾ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œåç«¯è°ƒç”¨DataFilterçš„filter_valid_notes_dataæ–¹æ³•ï¼Œå¯¹å½•åˆ¶å’Œæ’­æ”¾æ•°æ®åˆ†åˆ«è¿›è¡Œæœ‰æ•ˆæ€§è¿‡æ»¤ã€‚DataFilteræ£€æŸ¥æ¯ä¸ªéŸ³ç¬¦çš„æ•°æ®å®Œæ•´æ€§ï¼ˆafter_touchå’Œhammersä¸èƒ½ä¸ºç©ºï¼‰ã€ä¸å‘å£°æ£€æµ‹ï¼ˆé¦–ä¸ªé”¤é€Ÿä¸º0æˆ–ç”µæœºé˜ˆå€¼æ£€æŸ¥å¤±è´¥ï¼‰ã€æŒç»­æ—¶é—´æ£€æŸ¥ï¼ˆå°äº30msè§†ä¸ºè¿‡çŸ­ï¼‰ã€‚è¿‡æ»¤å®Œæˆåè¿”å›æœ‰æ•ˆæ•°æ®åˆ—è¡¨å’Œæ— æ•ˆç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒ…å«å„ç±»å‹æ— æ•ˆåŸå› çš„æ•°é‡å’Œä¸å‘å£°éŸ³ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚éšåï¼Œåç«¯è°ƒç”¨NoteMatcherçš„find_all_matched_pairsæ–¹æ³•æ‰§è¡ŒéŸ³ç¬¦åŒ¹é…ã€‚åŒ¹é…ç®—æ³•ä»¥å½•åˆ¶æ•°æ®ä¸ºåŸºå‡†ï¼Œéå†æ¯ä¸ªå½•åˆ¶éŸ³ç¬¦ï¼Œåœ¨æ’­æ”¾æ•°æ®ä¸­å¯»æ‰¾ç›¸åŒé”®IDçš„å€™é€‰ï¼Œè®¡ç®—keyon_offsetï¼ˆæŒ‰é”®å¼€å§‹æ—¶é—´å·®ï¼‰çš„ç»å¯¹å€¼ä½œä¸ºæ€»è¯¯å·®ï¼Œæ ¹æ®éŸ³ç¬¦æŒç»­æ—¶é—´åŠ¨æ€è®¡ç®—é˜ˆå€¼ï¼ˆ30-50msèŒƒå›´ï¼‰ï¼Œè¿‡æ»¤å¹¶æ’åºå€™é€‰ï¼Œé‡‡ç”¨è´ªå¿ƒç­–ç•¥é€‰æ‹©ç¬¬ä¸€ä¸ªæœªè¢«å ç”¨çš„å€™é€‰å»ºç«‹åŒ¹é…å¯¹ã€‚åŒ¹é…å®Œæˆåè¿”å›åŒ¹é…å¯¹åˆ—è¡¨å’Œå¤±è´¥åŸå› å­—å…¸ã€‚æ¥ç€ï¼Œåç«¯è°ƒç”¨ErrorDetectorçš„analyze_hammer_issuesæ–¹æ³•è¯†åˆ«å¼‚å¸¸é—®é¢˜ã€‚ErrorDetectoré€šè¿‡æ¯”è¾ƒå·²åŒ¹é…çš„éŸ³ç¬¦ç´¢å¼•é›†åˆå’ŒåŸå§‹æ•°æ®ï¼Œè¯†åˆ«å‡ºä¸¢é”¤ï¼ˆå½•åˆ¶æœ‰ä½†æ’­æ”¾æœªåŒ¹é…ï¼‰å’Œå¤šé”¤ï¼ˆæ’­æ”¾æœ‰ä½†å½•åˆ¶æœªåŒ¹é…ï¼‰ï¼Œä¸å‘å£°é—®é¢˜åˆ™ä»è¿‡æ»¤é˜¶æ®µçš„silent_notes_detailsä¸­æå–ã€‚å¼‚å¸¸æ£€æµ‹å®Œæˆåï¼Œåç«¯è°ƒç”¨TableDataGeneratorç”Ÿæˆå„ç±»è¡¨æ ¼æ•°æ®ï¼ŒåŒ…æ‹¬ç»Ÿè®¡æ¦‚è§ˆï¼ˆæ€»éŸ³ç¬¦æ•°ã€æœ‰æ•ˆéŸ³ç¬¦æ•°ã€åŒ¹é…å¯¹æ•°ã€å‡†ç¡®ç‡ã€å¹³å‡æ—¶å»¶ç­‰ï¼‰ã€ä¸¢é”¤é—®é¢˜åˆ—è¡¨ã€å¤šé”¤é—®é¢˜åˆ—è¡¨ã€ä¸å‘å£°é—®é¢˜åˆ—è¡¨ã€åç§»å¯¹é½åˆ†æè¡¨æ ¼ç­‰ã€‚åŒæ—¶ï¼ŒPlotGeneratorç”Ÿæˆç€‘å¸ƒå›¾ï¼Œå±•ç¤ºå½•åˆ¶å’Œæ’­æ”¾æ•°æ®çš„æ—¶é—´è½´å¯¹æ¯”ã€‚æœ€åï¼Œåç«¯å°†æ‰€æœ‰æ•°æ®ï¼ˆè¡¨æ ¼æ•°æ®ã€å›¾è¡¨ã€ç»Ÿè®¡ä¿¡æ¯ï¼‰è¿”å›UIå±‚ï¼ŒUIå±‚è¿›è¡Œå•ä½è½¬æ¢ï¼ˆ0.1msè½¬ä¸ºmsæ˜¾ç¤ºï¼‰å¹¶æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„åˆ†æç»“æœã€‚

```mermaid
sequenceDiagram
  participant User as User
  participant UI as Dash UI
  participant BE as Backend
  participant RD as SPMidReader
  participant DF as DataFilter
  participant NM as NoteMatcher
  participant ED as ErrorDetector
  participant TG as TableDataGenerator

  User->>UI: ä¸Šä¼ /é€‰æ‹©SPMIDæ–‡ä»¶
  UI->>BE: load_spmid_data(spmid_bytes)
  BE->>RD: from_file(temp_path)
  RD-->>BE: record_data, replay_data (List[Note])
  BE->>DF: filter_valid_notes_data(record, replay)
  DF-->>BE: valid_record, valid_replay, invalid_counts
  BE->>NM: find_all_matched_pairs(valid_record, valid_replay)
  NM-->>BE: matched_pairs, failure_reasons
  BE->>ED: analyze_hammer_issues(valid_record, valid_replay, matched_pairs)
  ED-->>BE: drop_hammers, multi_hammers
  BE->>TG: ç”Ÿæˆè¡¨æ ¼ä¸ç»Ÿè®¡
  TG-->>BE: æ¦‚è§ˆ/é—®é¢˜åˆ—è¡¨æ•°æ®
  BE-->>UI: ç€‘å¸ƒå›¾/ç»Ÿè®¡å¡ç‰‡/è¡¨æ ¼æ•°æ®
  UI-->>User: å±•ç¤ºç»“æœ
```

### æŒ‰é”®åŒ¹é…æµç¨‹å›¾ï¼ˆåŠ¨æ€é˜ˆå€¼ + ä¸€å¯¹ä¸€ï¼‰

**åŒ¹é…æµç¨‹è¯¦ç»†è¯´æ˜**ï¼š

åŒ¹é…ç®—æ³•é‡‡ç”¨ä»¥å½•åˆ¶æ•°æ®ä¸ºåŸºå‡†çš„è´ªå¿ƒåŒ¹é…ç­–ç•¥ï¼Œä¸¥æ ¼éµå¾ªä¸€å¯¹ä¸€åŒ¹é…åŸåˆ™ã€‚æ•´ä¸ªæµç¨‹ä»éå†å½•åˆ¶æ•°æ®ä¸­çš„æ¯ä¸ªéŸ³ç¬¦å¼€å§‹ã€‚å¯¹äºå½“å‰å¤„ç†çš„å½•åˆ¶éŸ³ç¬¦ï¼ˆç´¢å¼•iï¼‰ï¼Œé¦–å…ˆæå–å…¶åŸºæœ¬ä¿¡æ¯ï¼ˆnote_infoï¼‰ï¼ŒåŒ…æ‹¬é”®IDï¼ˆkey_idï¼‰ã€æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆkeyon = after_touch.index[0] + offsetï¼‰å’ŒæŒ‰é”®ç»“æŸæ—¶é—´ï¼ˆkeyoff = after_touch.index[-1] + offsetï¼‰ï¼Œè¿™äº›æ—¶é—´å€¼å‡ä»¥0.1msä¸ºå•ä½ã€‚æ¥ç€ï¼Œåœ¨æ’­æ”¾æ•°æ®ï¼ˆreplayï¼‰ä¸­ç­›é€‰å‡ºæ‰€æœ‰ä¸å½“å‰å½•åˆ¶éŸ³ç¬¦å…·æœ‰ç›¸åŒé”®IDçš„éŸ³ç¬¦ä½œä¸ºå€™é€‰é›†åˆã€‚å¯¹äºæ¯ä¸ªå€™é€‰éŸ³ç¬¦ï¼Œç®—æ³•è®¡ç®—å…¶æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆcurrent_keyonï¼‰ä¸ç›®æ ‡å½•åˆ¶éŸ³ç¬¦çš„æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆtarget_keyonï¼‰çš„å·®å€¼ï¼Œå¾—åˆ°keyon_offset = current_keyon - target_keyonï¼Œç„¶åå°†è¯¥å·®å€¼çš„ç»å¯¹å€¼ä½œä¸ºæ€»è¯¯å·®ï¼ˆtotal_error = |keyon_offset|ï¼‰ã€‚æ³¨æ„ï¼šå½“å‰ç®—æ³•ä»…ä½¿ç”¨keyon_offsetè®¡ç®—è¯¯å·®ï¼Œä¸å†ä½¿ç”¨keyoffå·®æˆ–åŠ æƒç»„åˆï¼Œè¿™ç®€åŒ–äº†è®¡ç®—é€»è¾‘å¹¶ä¸“æ³¨äºèŠ‚å¥å¯¹é½ã€‚éšåï¼Œç®—æ³•æ ¹æ®ç›®æ ‡éŸ³ç¬¦çš„æŒç»­æ—¶é—´åŠ¨æ€è®¡ç®—åŒ¹é…é˜ˆå€¼ã€‚åŸºç¡€é˜ˆå€¼ä¸º500ï¼ˆå¯¹åº”50æ¯«ç§’ï¼‰ï¼ŒæŒç»­æ—¶é—´å› å­é€šè¿‡å…¬å¼duration_factor = clamp(0.6, duration/500, 1.0)è®¡ç®—ï¼Œå…¶ä¸­duration = target_keyoff - target_keyonï¼ˆå•ä½0.1msï¼‰ã€‚å¦‚æœduration <= 0ï¼Œåˆ™åˆ¤å®šä¸ºå¼‚å¸¸éŸ³ç¬¦ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚æœ€ç»ˆé˜ˆå€¼max_allowed_error = base_threshold Ã— duration_factorï¼ŒèŒƒå›´åœ¨300åˆ°500ï¼ˆå¯¹åº”30åˆ°50æ¯«ç§’ï¼‰ä¹‹é—´ã€‚æ—¶å€¼è¶Šé•¿çš„éŸ³ç¬¦ï¼Œå…è®¸çš„keyonåç§»ä¸Šé™é€‚å½“å¢å¤§ï¼Œä½†æœ€å¤§ä¸è¶…è¿‡50msï¼Œä»¥æ§åˆ¶åŒ¹é…çš„ä¸¥æ ¼åº¦ã€‚ç®—æ³•è¿‡æ»¤å‡ºæ€»è¯¯å·®åœ¨åŠ¨æ€é˜ˆå€¼èŒƒå›´å†…çš„æ‰€æœ‰å€™é€‰ï¼Œå¹¶æŒ‰æ€»è¯¯å·®ä»å°åˆ°å¤§è¿›è¡Œå‡åºæ’åºï¼Œç¡®ä¿æœ€ä¼˜å€™é€‰æ’åœ¨å‰é¢ã€‚æ¥ä¸‹æ¥è¿›è¡ŒåŒ¹é…åˆ¤æ–­ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªè¢«å ç”¨çš„å€™é€‰ï¼ˆé€šè¿‡used_replay_indicesé›†åˆè¿½è¸ªå·²è¢«åŒ¹é…çš„æ’­æ”¾éŸ³ç¬¦ç´¢å¼•ï¼‰ã€‚å¦‚æœå­˜åœ¨æœªå ç”¨çš„å€™é€‰ï¼Œåˆ™é€‰æ‹©æ’åºåçš„ç¬¬ä¸€ä¸ªæœªå ç”¨å€™é€‰ï¼Œå»ºç«‹åŒ¹é…å¯¹ï¼ˆè®°å½•å½•åˆ¶ç´¢å¼•ã€æ’­æ”¾ç´¢å¼•ã€ä¸¤ä¸ªNoteå¯¹è±¡ï¼‰ï¼Œå°†è¯¥å€™é€‰çš„ç´¢å¼•åŠ å…¥å·²ä½¿ç”¨é›†åˆï¼ˆused_replay_indices.add(replay_index)ï¼‰ï¼Œå¹¶è®°å½•åŒ¹é…æˆåŠŸçš„è¯¦ç»†ä¿¡æ¯åˆ°æ—¥å¿—ï¼ˆåŒ…æ‹¬é”®IDã€å½•åˆ¶å’Œæ’­æ”¾ç´¢å¼•ã€æ—¶é—´æˆ³ã€åç§»é‡ã€æ€»è¯¯å·®ã€é˜ˆå€¼ç­‰ï¼‰ã€‚ç„¶åå¤„ç†ä¸‹ä¸€ä¸ªå½•åˆ¶éŸ³ç¬¦ï¼Œé‡å¤ä¸Šè¿°æµç¨‹ã€‚å¦‚æœæ‰€æœ‰å€™é€‰éƒ½å·²è¢«å ç”¨ï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å€™é€‰ï¼ˆå³æ²¡æœ‰ç›¸åŒé”®IDçš„éŸ³ç¬¦ï¼Œæˆ–æ‰€æœ‰å€™é€‰çš„æ€»è¯¯å·®éƒ½è¶…å‡ºåŠ¨æ€é˜ˆå€¼ï¼‰ï¼Œåˆ™åˆ¤å®šå½“å‰å½•åˆ¶éŸ³ç¬¦åŒ¹é…å¤±è´¥ï¼Œè®°å½•å¤±è´¥åŸå› åˆ°failure_reasonså­—å…¸ï¼ˆå¦‚"æ‰€æœ‰å€™é€‰å·²è¢«å ç”¨(å€™é€‰æ•°:X, é˜ˆå€¼:Yms)"æˆ–"æ—¶é—´è¯¯å·®è¿‡å¤§(è¯¯å·®:Xms, é˜ˆå€¼:Yms)"ï¼‰ï¼ŒåŒæ—¶è®°å½•å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯åˆ°æ—¥å¿—ï¼ŒåŒ…æ‹¬å‰å‡ ä¸ªå€™é€‰çš„æ—¶é—´æˆ³å’Œè¯¯å·®ä¿¡æ¯ã€‚ç®—æ³•ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå½•åˆ¶éŸ³ç¬¦ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰å½•åˆ¶æ•°æ®ã€‚æœ€åï¼Œç»Ÿè®¡åŒ¹é…ç»“æœï¼Œè¾“å‡ºæˆåŠŸåŒ¹é…çš„å¯¹æ•°ã€å¤±è´¥çš„æ•°é‡ä»¥åŠåŒ¹é…æˆåŠŸç‡ï¼ˆsuccess_count/len(record_data)*100%ï¼‰ï¼Œå®Œæˆæ•´ä¸ªåŒ¹é…è¿‡ç¨‹ã€‚æ•´ä¸ªæµç¨‹çš„æ ¸å¿ƒç‰¹ç‚¹åŒ…æ‹¬ï¼šä¸€å¯¹ä¸€çº¦æŸï¼ˆæ¯ä¸ªæ’­æ”¾éŸ³ç¬¦æœ€å¤šåŒ¹é…ä¸€æ¬¡ï¼‰ã€è´ªå¿ƒç­–ç•¥ï¼ˆä¼˜å…ˆé€‰æ‹©è¯¯å·®æœ€å°çš„å€™é€‰ï¼‰ã€åŠ¨æ€é˜ˆå€¼ï¼ˆæ ¹æ®éŸ³ç¬¦ç‰¹æ€§è‡ªé€‚åº”è°ƒæ•´å®¹é”™èŒƒå›´ï¼‰ï¼Œç¡®ä¿åŒ¹é…ç»“æœçš„å‡†ç¡®æ€§å’Œå”¯ä¸€æ€§ã€‚

```mermaid

```

## ç³»ç»Ÿæ¶æ„å›¾ï¼ˆè¯¦ç»†å±‚æ¬¡è¯´æ˜ï¼‰

**æ¶æ„åˆ†å±‚è¯¦ç»†è¯´æ˜**ï¼š

æœ¬å›¾å±•ç¤ºäº†ç³»ç»Ÿå®Œæ•´çš„åˆ†å±‚æ¶æ„å’Œå„ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€‚UI Layerï¼ˆç”¨æˆ·ç•Œé¢å±‚ï¼‰æ˜¯ç”¨æˆ·äº¤äº’çš„å…¥å£ï¼ŒåŒ…å«Dash Web Interfaceä½œä¸ºä¸»ç•Œé¢æ¡†æ¶ï¼ŒLayout Componentsè´Ÿè´£å®šä¹‰é¡µé¢å¸ƒå±€ç»“æ„ï¼ˆåŒ…æ‹¬æ•°æ®ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ã€ç€‘å¸ƒå›¾ã€é—®é¢˜åˆ—è¡¨è¡¨æ ¼ã€åç§»å¯¹é½åˆ†æè¡¨æ ¼ç­‰ï¼‰ï¼ŒCallbackså¤„ç†æ‰€æœ‰ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ—¶é—´èŒƒå›´è¿‡æ»¤ã€å›¾è¡¨ç”Ÿæˆç­‰ï¼‰ã€‚Backend Layerï¼ˆåç«¯å±‚ï¼‰æä¾›ä¸šåŠ¡æœåŠ¡å’Œæ•°æ®è½¬æ¢ï¼ŒPianoAnalysisBackendæ˜¯æ ¸å¿ƒåè°ƒå™¨ï¼Œæ¥æ”¶UIå±‚çš„è¯·æ±‚å¹¶åè°ƒå„ä¸ªåˆ†æç»„ä»¶ï¼Œç®¡ç†ä¼šè¯çŠ¶æ€å’Œä¸´æ—¶æ–‡ä»¶ï¼›PlotGeneratorä¸“é—¨è´Ÿè´£ç”ŸæˆPlotlyæ ¼å¼çš„å¯è§†åŒ–å›¾è¡¨ï¼ˆç€‘å¸ƒå›¾ã€åç§»å¯¹é½æŸ±çŠ¶å›¾ç­‰ï¼‰ï¼›TableDataGeneratorè´Ÿè´£ç”Ÿæˆå„ç±»è¡¨æ ¼æ‰€éœ€çš„æ•°æ®æ ¼å¼ï¼ˆç»Ÿè®¡æ¦‚è§ˆã€é—®é¢˜åˆ—è¡¨ã€åç§»å¯¹é½è¡¨æ ¼ç­‰ï¼‰ï¼›DataManagerç®¡ç†æ•°æ®çš„åŠ è½½ã€ç¼“å­˜å’Œä¼šè¯çŠ¶æ€ã€‚SPMID Analysis Layerï¼ˆSPMIDåˆ†æå±‚ï¼‰åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒSPMIDAnalyzerä½œä¸ºæ€»åè°ƒå™¨ï¼Œè´Ÿè´£ç¼–æ’æ•´ä¸ªåˆ†ææµç¨‹ï¼ˆæ•°æ®åŠ è½½ã€è¿‡æ»¤ã€åŒ¹é…ã€å¼‚å¸¸æ£€æµ‹ã€ç»Ÿè®¡åˆ†æï¼‰ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£ï¼›DataFilteræ‰§è¡Œæ•°æ®æœ‰æ•ˆæ€§è¿‡æ»¤ï¼Œæ£€æŸ¥éŸ³ç¬¦çš„å®Œæ•´æ€§ã€ä¸å‘å£°çŠ¶æ€ã€æŒç»­æ—¶é—´ç­‰ï¼Œäº§å‡ºæœ‰æ•ˆæ•°æ®å’Œæ— æ•ˆç»Ÿè®¡ï¼›NoteMatcherå®ç°éŸ³ç¬¦åŒ¹é…ç®—æ³•ï¼ŒåŸºäºæ—¶é—´è¯¯å·®è¿›è¡Œè´ªå¿ƒåŒ¹é…ï¼Œç¡®ä¿ä¸€å¯¹ä¸€çº¦æŸï¼Œè®¡ç®—åç§»å¯¹é½æ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯ï¼›ErrorDetectorè¯†åˆ«å¼‚å¸¸é—®é¢˜ï¼ˆä¸¢é”¤ã€å¤šé”¤ï¼‰ï¼Œå¹¶åˆ†æåŒ¹é…å¤±è´¥çš„åŸå› ï¼›TimeAligneræä¾›æ—¶é—´å¯¹é½ç›¸å…³åŠŸèƒ½ï¼ˆå·²åºŸå¼ƒDTWç®—æ³•ï¼Œå½“å‰ä¸ä½¿ç”¨ï¼‰ã€‚Data Layerï¼ˆæ•°æ®å±‚ï¼‰è´Ÿè´£æ•°æ®è¯»å–å’ŒåŸºç¡€éªŒè¯ï¼ŒSPMidReaderè§£æSPMIDäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å¤´ã€ç´¢å¼•å—ã€NOTEå—ç­‰ï¼Œæ„é€ Noteå¯¹è±¡ï¼›Note Objectsæ˜¯æ•°æ®æ¨¡å‹ï¼ŒåŒ…å«offsetã€é”®IDã€hammersåºåˆ—ã€after_touchåºåˆ—ç­‰ï¼›MotorThresholdCheckeræ£€æŸ¥ç”µæœºé˜ˆå€¼ï¼Œç”¨äºè¯†åˆ«ä¸å‘å£°éŸ³ç¬¦ã€‚å„å±‚ä¹‹é—´çš„è°ƒç”¨å…³ç³»æ¸…æ™°ï¼šUIå±‚é€šè¿‡Callbacksè°ƒç”¨Backendå±‚çš„æ¥å£ï¼ŒBackendå±‚åè°ƒSPMIDåˆ†æå±‚çš„å„ä¸ªç»„ä»¶ï¼Œåˆ†æå±‚ç»„ä»¶ä¾èµ–æ•°æ®å±‚è¿›è¡Œæ•°æ®è¯»å–å’ŒéªŒè¯ï¼Œæœ€ç»ˆæ•°æ®æµå›UIå±‚è¿›è¡Œå±•ç¤ºã€‚è¿™ç§åˆ†å±‚è®¾è®¡å®ç°äº†å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```mermaid
flowchart TB
    subgraph "UI Layer"
        A[Dash Web Interface]
        B[Layout Components]
        C[Callbacks]
    end

    subgraph "Backend Layer"
        D[PianoAnalysisBackend]
        E[PlotGenerator]
        F[TableDataGenerator]
        G[DataManager]
    end

    subgraph "SPMID Analysis Layer"
        H[SPMIDAnalyzer]
        I[DataFilter]
        J[NoteMatcher]
        K[ErrorDetector]
        L[TimeAligner]
    end

    subgraph "Data Layer"
        M[SPMIDReader]
        N[MotorThresholdChecker]
        O[Note Objects]
    end

    A --> B
    B --> C
    C --> D
    D --> E
    D --> F
    D --> G
    D --> H
    H --> I
    H --> J
    H --> K
    H --> L
    I --> M
    J --> M
    K --> M
    M --> O
    I --> N
```

## æ•°æ®å•ä½è§„èŒƒ

**é‡è¦**ï¼šç³»ç»Ÿå†…éƒ¨ç»Ÿä¸€ä½¿ç”¨0.1msä½œä¸ºæ—¶é—´å•ä½ï¼Œä»…åœ¨UIå±•ç¤ºæ—¶è½¬æ¢ä¸ºmsï¼ˆé™¤ä»¥10ï¼‰ã€‚

- å†…éƒ¨è®¡ç®—ï¼šæ‰€æœ‰æ—¶é—´æˆ³ã€åç§»é‡ã€æŒç»­æ—¶é—´å‡ä»¥0.1msä¸ºå•ä½
- UIæ˜¾ç¤ºï¼šæ—¶é—´ç›¸å…³æ•°æ®é™¤ä»¥10æ˜¾ç¤ºä¸ºms
- æ—¥å¿—è¾“å‡ºï¼šå…³é”®æ—¶é—´ä¿¡æ¯åŒæ—¶æ˜¾ç¤º0.1mså’Œmsä¸¤ç§å•ä½

## 1. æ•°æ®è¯»å–é˜¶æ®µ

### 1.1 æ–‡ä»¶ä¸Šä¼ ä¸è§£æ

**å…¥å£å‡½æ•°**ï¼š`backend/piano_analysis_backend.py:load_spmid_data()`

```python
def load_spmid_data(self, spmid_bytes: bytes) -> bool:
    """åŠ è½½SPMIDæ•°æ®çš„ä¸»å…¥å£"""
    try:
        # 1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        temp_file_path = self._create_temp_file(spmid_bytes)

        # 2. åŠ è½½è½¨é“æ•°æ®
        record_data, replay_data = self._load_track_data(temp_file_path)

        # 3. æ‰§è¡Œå®Œæ•´åˆ†æ
        self._perform_error_analysis(record_data, replay_data)

        # 4. æ›´æ–°æ—¶é—´èŒƒå›´
        self._update_time_range()

        return True
    finally:
        # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        self._cleanup_temp_file(temp_file_path)
```

### 1.2 è½¨é“æ•°æ®åŠ è½½

**æ ¸å¿ƒå‡½æ•°**ï¼š`_load_track_data(temp_file_path)`

```python
def _load_track_data(self, temp_file_path: str) -> Tuple[List[Note], List[Note]]:
    """åŠ è½½SPMIDæ–‡ä»¶çš„è½¨é“æ•°æ®"""
    reader = SPMidReader.from_file(temp_file_path, verbose=False)

    # éªŒè¯è½¨é“æ•°é‡
    if reader.get_track_count < 2:
        raise ValueError("SPMIDæ–‡ä»¶å¿…é¡»åŒ…å«è‡³å°‘2ä¸ªè½¨é“")

    # è·å–å½•åˆ¶å’Œæ’­æ”¾æ•°æ®
    record_data = reader.get_track(0)  # å½•åˆ¶æ•°æ®ï¼ˆå®é™…æ¼”å¥ï¼‰
    replay_data = reader.get_track(1)  # æ’­æ”¾æ•°æ®ï¼ˆMIDIå›æ”¾ï¼‰

    return record_data, replay_data
```

### 1.3 Noteæ•°æ®ç»“æ„

**å®šä¹‰ä½ç½®**ï¼š`spmid/spmid_reader.py`

```python
@dataclass
class Note:
    offset: int                    # æ—¶é—´åç§»é‡ï¼ˆ0.1mså•ä½ï¼‰
    id: int                       # é”®IDï¼ˆ1-88ï¼‰
    finger: int                   # æ‰‹æŒ‡ç¼–å·
    hammers: pd.Series           # é”¤é€Ÿæ•°æ®ï¼šindex=æ—¶é—´æˆ³, value=é”¤é€Ÿ
    uuid: str                    # å”¯ä¸€æ ‡è¯†ç¬¦
    velocity: int                # åˆå§‹é€Ÿåº¦
    after_touch: pd.Series       # è§¦åæ•°æ®ï¼šindex=æ—¶é—´æˆ³, value=æŒ‰é”®æ·±åº¦
```

**å…³é”®å±æ€§**ï¼š

- `hammers.index`ï¼šé”¤å‡»æ—¶é—´æˆ³ï¼ˆç›¸å¯¹offsetï¼Œ0.1mså•ä½ï¼‰
- `hammers.values`ï¼šé”¤å‡»é€Ÿåº¦å€¼
- `after_touch.index`ï¼šè§¦åæ—¶é—´æˆ³ï¼ˆç›¸å¯¹offsetï¼Œ0.1mså•ä½ï¼‰
- `after_touch.values`ï¼šæŒ‰é”®æ·±åº¦å€¼

## 2. æ•°æ®è¿‡æ»¤é˜¶æ®µ

### 2.1 è¿‡æ»¤æµç¨‹æ¦‚è§ˆ

**è¿‡æ»¤æµç¨‹è¯¦ç»†è¯´æ˜**ï¼š

æ•°æ®è¿‡æ»¤é˜¶æ®µæ˜¯åˆ†ææµç¨‹çš„å…³é”®é¢„å¤„ç†æ­¥éª¤ï¼Œå…¶ç›®çš„æ˜¯ä»åŸå§‹SPMIDæ•°æ®ä¸­ç­›é€‰å‡ºæœ‰æ•ˆçš„éŸ³ç¬¦ï¼Œå‰”é™¤æ— æ•ˆæˆ–å¼‚å¸¸çš„æ•°æ®ï¼Œä¸ºåç»­çš„åŒ¹é…å’Œåˆ†ææä¾›é«˜è´¨é‡çš„æ•°æ®åŸºç¡€ã€‚è¿‡æ»¤æµç¨‹å¯¹å½•åˆ¶æ•°æ®ï¼ˆrecord_dataï¼‰å’Œæ’­æ”¾æ•°æ®ï¼ˆreplay_dataï¼‰åˆ†åˆ«è¿›è¡Œç›¸åŒçš„æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œç¡®ä¿ä¸¤ä¸ªæ•°æ®é›†çš„ä¸€è‡´æ€§ã€‚æ•´ä¸ªè¿‡æ»¤è¿‡ç¨‹é€šè¿‡`filter_valid_notes_data`æ–¹æ³•åè°ƒï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨`_filter_valid_notes_with_details`å¯¹å½•åˆ¶æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œè¿”å›æœ‰æ•ˆå½•åˆ¶æ•°æ®åˆ—è¡¨å’Œæ— æ•ˆç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒ…æ‹¬å„ç±»æ— æ•ˆåŸå› çš„æ•°é‡å’Œä¸å‘å£°éŸ³ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚ç„¶åå¯¹æ’­æ”¾æ•°æ®æ‰§è¡Œç›¸åŒçš„è¿‡æ»¤æ“ä½œï¼Œè¿”å›æœ‰æ•ˆæ’­æ”¾æ•°æ®åˆ—è¡¨å’Œå¯¹åº”çš„æ— æ•ˆç»Ÿè®¡ä¿¡æ¯ã€‚æœ€åï¼Œå°†å½•åˆ¶å’Œæ’­æ”¾çš„æ— æ•ˆç»Ÿè®¡ä¿¡æ¯åˆå¹¶åˆ°ä¸€ä¸ªå­—å…¸ä¸­ï¼Œç»Ÿä¸€è¿”å›ç»™è°ƒç”¨è€…ã€‚è¿‡æ»¤è¿‡ç¨‹ä¼šç»Ÿè®¡å››ç§æ— æ•ˆåŸå› ï¼šempty_dataï¼ˆæ•°æ®ä¸ºç©ºï¼Œafter_touchæˆ–hammersåºåˆ—ä¸ºç©ºï¼‰ã€silent_notesï¼ˆä¸å‘å£°éŸ³ç¬¦ï¼Œé”¤é€Ÿä¸º0æˆ–ç”µæœºé˜ˆå€¼æ£€æŸ¥å¤±è´¥ï¼‰ã€duration_too_shortï¼ˆæŒç»­æ—¶é—´è¿‡çŸ­ï¼Œå°äº30msï¼‰ä»¥åŠvalidï¼ˆæœ‰æ•ˆéŸ³ç¬¦ï¼‰ã€‚å¯¹äºä¸å‘å£°éŸ³ç¬¦ï¼Œç³»ç»Ÿä¼šç‰¹åˆ«ä¿å­˜è¯¦ç»†ä¿¡æ¯ï¼ˆsilent_notes_detailsï¼‰ï¼ŒåŒ…æ‹¬éŸ³ç¬¦ç´¢å¼•ã€Noteå¯¹è±¡æœ¬èº«å’Œæ•°æ®ç±»å‹ï¼ˆrecordæˆ–replayï¼‰ï¼Œè¿™äº›ä¿¡æ¯å°†åœ¨åç»­çš„å¼‚å¸¸æ£€æµ‹é˜¶æ®µç”¨äºç”Ÿæˆ"ä¸å‘å£°"é—®é¢˜åˆ—è¡¨ã€‚è¿‡æ»¤å®Œæˆåçš„æœ‰æ•ˆæ•°æ®å°†è¿›å…¥åŒ¹é…é˜¶æ®µï¼Œæ— æ•ˆç»Ÿè®¡æ•°æ®å°†ç”¨äºç”Ÿæˆé—®é¢˜åˆ—è¡¨å’Œç»Ÿè®¡æ¦‚è§ˆã€‚

**å…¥å£å‡½æ•°**ï¼š`spmid/data_filter.py:filter_valid_notes_data()`

```python
def filter_valid_notes_data(self, record_data: List[Note], replay_data: List[Note]) -> Tuple[List[Note], List[Note], Dict[str, Any]]:
    """è¿‡æ»¤æœ‰æ•ˆéŸ³ç¬¦æ•°æ®çš„ä¸»å‡½æ•°"""

    # 1. è¿‡æ»¤å½•åˆ¶æ•°æ®
    valid_record_data, record_invalid_counts = self._filter_valid_notes_with_details(record_data, "record")

    # 2. è¿‡æ»¤æ’­æ”¾æ•°æ®
    valid_replay_data, replay_invalid_counts = self._filter_valid_notes_with_details(replay_data, "replay")

    # 3. åˆå¹¶ç»Ÿè®¡ä¿¡æ¯
    invalid_counts = {
        'record_data': record_invalid_counts,
        'replay_data': replay_invalid_counts
    }

    return valid_record_data, valid_replay_data, invalid_counts
```

### 2.2 æœ‰æ•ˆæ€§åˆ¤å®šè§„åˆ™

**æœ‰æ•ˆæ€§åˆ¤å®šè¯¦ç»†è¯´æ˜**ï¼š

æœ‰æ•ˆæ€§åˆ¤å®šé€šè¿‡`_is_note_valid_with_reason`æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•å¯¹å•ä¸ªéŸ³ç¬¦è¿›è¡Œå¤šå±‚æ¬¡çš„æ£€æŸ¥ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºé€æ­¥éªŒè¯ï¼Œä¸€æ—¦å‘ç°æ— æ•ˆæƒ…å†µç«‹å³è¿”å›ã€‚åˆ¤å®šçš„ä¼˜å…ˆçº§é¡ºåºä¸ºï¼šæ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ã€é”¤é€Ÿæ£€æŸ¥ã€æŒç»­æ—¶é—´æ£€æŸ¥ã€ç”µæœºé˜ˆå€¼æ£€æŸ¥ã€‚é¦–å…ˆè¿›è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼šå¦‚æœéŸ³ç¬¦çš„after_touchåºåˆ—æˆ–hammersåºåˆ—ä¸ºç©ºï¼ˆé•¿åº¦ä¸º0ï¼‰ï¼Œåˆ™åˆ¤å®šä¸ºæ— æ•ˆï¼Œè¿”å›åŸå› 'empty_data'ã€‚æ•°æ®å®Œæ•´æ€§æ˜¯æœ€åŸºæœ¬çš„æ£€æŸ¥ï¼Œç¡®ä¿åç»­æ£€æŸ¥èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œã€‚æ¥ä¸‹æ¥è¿›è¡Œé”¤é€Ÿæ£€æŸ¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ï¼šè·å–hammersåºåˆ—çš„ç¬¬ä¸€ä¸ªå€¼ï¼ˆfirst_hammer_velocityï¼‰ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªä¸å‘å£°éŸ³ç¬¦ï¼Œç«‹å³åˆ¤å®šä¸ºæ— æ•ˆï¼Œè¿”å›åŸå› 'silent_notes'ï¼Œå¹¶è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚é”¤é€Ÿä¸º0é€šå¸¸è¡¨ç¤ºé”®ç›˜æœªè¢«æ­£ç¡®è§¦å‘æˆ–ä¼ æ„Ÿå™¨æ•…éšœã€‚ç„¶åè¿›è¡ŒæŒç»­æ—¶é—´æ£€æŸ¥ï¼šè®¡ç®—éŸ³ç¬¦çš„æŒç»­æ—¶é—´duration = after_touch.index[-1] - after_touch.index[0]ï¼ˆå•ä½0.1msï¼‰ï¼Œå¦‚æœduration < 300ï¼ˆå³å°äº30msï¼‰ï¼Œåˆ™åˆ¤å®šä¸ºæŒç»­æ—¶é—´è¿‡çŸ­ï¼Œè¿”å›åŸå› 'duration_too_short'ã€‚å°äº30msçš„éŸ³ç¬¦åœ¨çœŸå®é’¢ç´æ¼”å¥ä¸­æä¸ºç½•è§ï¼Œé€šå¸¸æ˜¯è¯¯è§¦ã€å™ªå£°æˆ–æ•°æ®é‡‡é›†é”™è¯¯å¯¼è‡´çš„ï¼Œå› æ­¤è¢«è§†ä¸ºæ— æ•ˆã€‚æœ€åè¿›è¡Œç”µæœºé˜ˆå€¼æ£€æŸ¥ï¼šå¦‚æœç³»ç»Ÿé…ç½®äº†MotorThresholdCheckerï¼ˆç”µæœºé˜ˆå€¼æ£€æŸ¥å™¨ï¼‰ï¼Œåˆ™æ ¹æ®éŸ³ç¬¦çš„é”®IDæ„é€ å¯¹åº”çš„ç”µæœºåç§°ï¼ˆmotor_{note.id}ï¼‰ï¼Œè°ƒç”¨é˜ˆå€¼æ£€æŸ¥å™¨éªŒè¯é¦–ä¸ªé”¤é€Ÿå€¼æ˜¯å¦è¶…è¿‡è¯¥ç”µæœºçš„å¯åŠ¨é˜ˆå€¼ã€‚å¦‚æœé˜ˆå€¼æ£€æŸ¥å¤±è´¥ï¼Œè¯´æ˜è¯¥éŸ³ç¬¦çš„é”¤é€Ÿè™½ç„¶ä¸ä¸º0ï¼Œä½†æœªè¾¾åˆ°ç”µæœºçš„æœ‰æ•ˆè§¦å‘é˜ˆå€¼ï¼ŒåŒæ ·åˆ¤å®šä¸ºä¸å‘å£°éŸ³ç¬¦ï¼Œè¿”å›åŸå› 'silent_notes'ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œè¿”å›Trueå’Œ'valid'ï¼Œè¡¨ç¤ºè¯¥éŸ³ç¬¦æœ‰æ•ˆã€‚æ•´ä¸ªåˆ¤å®šè¿‡ç¨‹é‡‡ç”¨çŸ­è·¯é€»è¾‘ï¼Œä¸€æ—¦å‘ç°æ— æ•ˆæƒ…å†µç«‹å³è¿”å›ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—ã€‚

**æ ¸å¿ƒå‡½æ•°**ï¼š`_is_note_valid_with_reason()`

```python
def _is_note_valid_with_reason(self, note: Note) -> Tuple[bool, str]:
    """åˆ¤å®šéŸ³ç¬¦æ˜¯å¦æœ‰æ•ˆï¼Œè¿”å›(æ˜¯å¦æœ‰æ•ˆ, æ— æ•ˆåŸå› )"""

    # 1. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    if len(note.after_touch) == 0 or len(note.hammers) == 0:
        return False, 'empty_data'

    # 2. é”¤é€Ÿæ£€æŸ¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    first_hammer_velocity = note.hammers.values[0]
    if first_hammer_velocity == 0:
        logger.info(f"ğŸ”‡ å‘ç°ä¸å‘å£°éŸ³ç¬¦: éŸ³ç¬¦ID={note.id}, é”¤é€Ÿ={first_hammer_velocity}")
        return False, 'silent_notes'

    # 3. æŒç»­æ—¶é—´æ£€æŸ¥
    duration = note.after_touch.index[-1] - note.after_touch.index[0]
    if duration < 300:  # 30msï¼ˆ300 * 0.1msï¼‰
        return False, 'duration_too_short'

    # 4. ç”µæœºé˜ˆå€¼æ£€æŸ¥
    if self.threshold_checker:
        motor_name = f"motor_{note.id}"
        is_valid = self.threshold_checker.check_threshold(first_hammer_velocity, motor_name)
        if not is_valid:
            logger.info(f"ğŸ”‡ éŸ³ç¬¦ID={note.id} è¢«è¯†åˆ«ä¸ºä¸å‘å£°éŸ³ç¬¦: é˜ˆå€¼æ£€æŸ¥å¤±è´¥, é”¤é€Ÿ={first_hammer_velocity}")
            return False, 'silent_notes'

    return True, 'valid'
```

### 2.3 è¿‡æ»¤ç»Ÿè®¡ä¸è¯¦æƒ…

**ç»Ÿè®¡åˆ†ç±»**ï¼š

- `empty_data`ï¼šæ•°æ®ä¸ºç©ºï¼ˆafter_touchæˆ–hammersä¸ºç©ºï¼‰
- `silent_notes`ï¼šä¸å‘å£°éŸ³ç¬¦ï¼ˆé”¤é€Ÿä¸º0æˆ–é˜ˆå€¼æ£€æŸ¥å¤±è´¥ï¼‰
- `duration_too_short`ï¼šæŒç»­æ—¶é—´è¿‡çŸ­ï¼ˆ<30msï¼‰
- `valid`ï¼šæœ‰æ•ˆéŸ³ç¬¦

**ç‰¹æ®Šå¤„ç†**ï¼š`silent_notes_details`

- å­˜å‚¨ä¸å‘å£°éŸ³ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼ˆindex, note, data_typeï¼‰
- ç”¨äºåç»­ç”Ÿæˆ"ä¸å‘å£°"é—®é¢˜åˆ—è¡¨

## 3. éŸ³ç¬¦åŒ¹é…é˜¶æ®µ

### 3.1 åŒ¹é…ç®—æ³•æ¦‚è¿°

**æ ¸å¿ƒæ€æƒ³**ï¼šåŸºäºæ—¶é—´è¯¯å·®çš„è´ªå¿ƒåŒ¹é…ç®—æ³•ï¼Œç¡®ä¿ä¸€å¯¹ä¸€åŒ¹é…

**ç®—æ³•ç‰¹ç‚¹**ï¼š

- ä»¥å½•åˆ¶æ•°æ®ä¸ºåŸºå‡†ï¼Œåœ¨æ’­æ”¾æ•°æ®ä¸­å¯»æ‰¾åŒ¹é…
- é”®IDå¿…é¡»ç›¸åŒ
- åŸºäºåŠ¨æ€é˜ˆå€¼çš„æ—¶é—´è¯¯å·®åŒ¹é…
- ä¸€å¯¹ä¸€çº¦æŸï¼šæ¯ä¸ªæ’­æ”¾éŸ³ç¬¦æœ€å¤šåŒ¹é…ä¸€æ¬¡

### 3.2 åŒ¹é…æµç¨‹è¯¦è§£

**å…¥å£å‡½æ•°**ï¼š`spmid/note_matcher.py:find_all_matched_pairs()`

```python
def find_all_matched_pairs(self, record_data: List[Note], replay_data: List[Note]) -> List[Tuple[int, int, Note, Note]]:
    """ä»¥å½•åˆ¶æ•°æ®ä¸ºåŸºå‡†ï¼Œåœ¨æ’­æ”¾æ•°æ®ä¸­å¯»æ‰¾åŒ¹é…çš„éŸ³ç¬¦å¯¹"""

    matched_pairs = []
    used_replay_indices = set()  # é˜²æ­¢é‡å¤åŒ¹é…
    self.failure_reasons.clear()  # æ¸…ç©ºå¤±è´¥åŸå› 

    logger.info(f"ğŸ¯ å¼€å§‹éŸ³ç¬¦åŒ¹é…: å½•åˆ¶æ•°æ®{len(record_data)}ä¸ªéŸ³ç¬¦, å›æ”¾æ•°æ®{len(replay_data)}ä¸ªéŸ³ç¬¦")

    # éå†å½•åˆ¶æ•°æ®ä¸­çš„æ¯ä¸ªéŸ³ç¬¦
    for i, record_note in enumerate(record_data):
        # 1. æå–éŸ³ç¬¦ä¿¡æ¯
        note_info = self._extract_note_info(record_note, i)

        # 2. ç”Ÿæˆå€™é€‰åˆ—è¡¨
        candidates, threshold, reason_if_empty = self._generate_sorted_candidates_within_threshold(
            replay_data, note_info["keyon"], note_info["keyoff"], note_info["key_id"]
        )

        # 3. é€‰æ‹©æœ€ä½³åŒ¹é…
        chosen = None
        for cand in candidates:
            if cand['index'] not in used_replay_indices:
                chosen = cand
                break

        # 4. å¤„ç†åŒ¹é…ç»“æœ
        if chosen is not None:
            # åŒ¹é…æˆåŠŸ
            replay_index = chosen['index']
            matched_pairs.append((i, replay_index, record_note, replay_data[replay_index]))
            used_replay_indices.add(replay_index)

            # è®°å½•æˆåŠŸæ—¥å¿—
            self._log_match_success(record_note, replay_data[replay_index], i, replay_index, chosen, threshold)
        else:
            # åŒ¹é…å¤±è´¥
            reason = f"æ‰€æœ‰å€™é€‰å·²è¢«å ç”¨(å€™é€‰æ•°:{len(candidates)}, é˜ˆå€¼:{threshold:.1f}ms)" if candidates else reason_if_empty
            self.failure_reasons[("record", i)] = reason
            self._log_match_failure(record_note, i, reason, candidates)

    # è®°å½•åŒ¹é…ç»Ÿè®¡
    success_count = len(matched_pairs)
    failure_count = len(record_data) - success_count
    logger.info(f"ğŸ¯ éŸ³ç¬¦åŒ¹é…å®Œæˆ: æˆåŠŸåŒ¹é…{success_count}å¯¹, å¤±è´¥{failure_count}ä¸ª, æˆåŠŸç‡{success_count/len(record_data)*100:.1f}%")

    self.matched_pairs = matched_pairs
    return matched_pairs
```

### 3.3 éŸ³ç¬¦ä¿¡æ¯æå–

**å‡½æ•°**ï¼š`_extract_note_info()`

```python
def _extract_note_info(self, note: Note, index: int) -> Dict:
    """æå–éŸ³ç¬¦åŸºæœ¬ä¿¡æ¯"""

    # è®¡ç®—ç»å¯¹æ—¶é—´æˆ³ï¼ˆ0.1mså•ä½ï¼‰
    absolute_keyon = note.after_touch.index[0] + note.offset
    absolute_keyoff = note.after_touch.index[-1] + note.offset

    return {
        'keyon': absolute_keyon,      # æŒ‰é”®å¼€å§‹æ—¶é—´
        'keyoff': absolute_keyoff,    # æŒ‰é”®ç»“æŸæ—¶é—´
        'key_id': note.id,           # é”®ID
        'index': index               # éŸ³ç¬¦ç´¢å¼•
    }
```

### 3.4 å€™é€‰ç”Ÿæˆä¸ç­›é€‰

**æ ¸å¿ƒå‡½æ•°**ï¼š`_generate_sorted_candidates_within_threshold()`

```python
def _generate_sorted_candidates_within_threshold(self, notes_list: List[Note], target_keyon: float, target_keyoff: float, target_key_id: int) -> Tuple[List[Dict[str, float]], float, str]:
    """ç”Ÿæˆåœ¨åŠ¨æ€é˜ˆå€¼å†…çš„å€™é€‰åˆ—è¡¨ï¼ˆæŒ‰æ€»è¯¯å·®å‡åºï¼‰"""

    # 1. ç­›é€‰ç›¸åŒé”®IDçš„éŸ³ç¬¦
    matching = []
    for idx, note in enumerate(notes_list):
        if getattr(note, 'id', None) == target_key_id:
            matching.append((idx, note))

    if not matching:
        return [], 0.0, f"æ²¡æœ‰æ‰¾åˆ°é”®ID {target_key_id} çš„éŸ³ç¬¦"

    # 2. è®¡ç®—æ¯ä¸ªå€™é€‰çš„è¯¯å·®ï¼ˆåªä½¿ç”¨keyon_offsetï¼‰
    candidates = []
    for idx, note in matching:
        # è®¡ç®—å€™é€‰éŸ³ç¬¦çš„æ—¶é—´
            current_keyon = note.after_touch.index[0] + note.offset
            current_keyoff = note.after_touch.index[-1] + note.offset

        # è®¡ç®—æ—¶é—´è¯¯å·®ï¼ˆåªä½¿ç”¨keyon_offsetï¼‰
        keyon_offset = current_keyon - target_keyon
        total_error = abs(keyon_offset)  # åªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼

        candidates.append({
            'index': idx,
            'total_error': total_error,
            'keyon_error': abs(keyon_offset)
        })

    # 3. åŠ¨æ€é˜ˆå€¼è®¡ç®—
    base_threshold = 500.0  # åŸºç¡€é˜ˆå€¼ï¼š500 * 0.1ms = 50ms
    duration = (target_keyoff - target_keyon)
    if duration <= 0:
        return [], 0.0, "æ— æ•ˆæŒç»­æ—¶é—´(â‰¤0)ï¼Œç–‘ä¼¼å¼‚å¸¸éŸ³ç¬¦"
    duration_factor = min(1.0, max(0.6, duration / 500.0))  # æŒç»­æ—¶é—´å› å­ï¼š0.6-1.0
    max_allowed_error = base_threshold * duration_factor  # å®é™…é˜ˆå€¼ï¼š300-500 * 0.1ms (30-50ms)

    # 4. è¿‡æ»¤å¹¶æ’åº
    within_threshold = [c for c in candidates if c['total_error'] <= max_allowed_error]
    within_threshold.sort(key=lambda x: x['total_error'])

    if not within_threshold:
        best_total = min(c['total_error'] for c in candidates)
        return [], max_allowed_error, f"æ—¶é—´è¯¯å·®è¿‡å¤§(è¯¯å·®:{best_total:.1f}ms, é˜ˆå€¼:{max_allowed_error:.1f}ms)"

    return within_threshold, max_allowed_error, ""
```

### 3.5 åŒ¹é…æ—¥å¿—è®°å½•

**æˆåŠŸåŒ¹é…æ—¥å¿—**ï¼š

```
âœ… åŒ¹é…æˆåŠŸ: é”®ID=60, å½•åˆ¶ç´¢å¼•=0, å›æ”¾ç´¢å¼•=0, å½•åˆ¶æ—¶é—´=(100.50ms, 200.30ms), å›æ”¾æ—¶é—´=(102.10ms, 201.80ms), åç§»=(1.60ms, 1.50ms), æ€»è¯¯å·®=1.60ms, é˜ˆå€¼=45.00ms
```

**å¤±è´¥åŒ¹é…æ—¥å¿—**ï¼š

```
âŒ åŒ¹é…å¤±è´¥: é”®ID=61, å½•åˆ¶ç´¢å¼•=1, å½•åˆ¶æ—¶é—´=(250.20ms, 350.10ms), åŸå› : æ‰€æœ‰å€™é€‰å·²è¢«å ç”¨(å€™é€‰æ•°:2, é˜ˆå€¼:45.0ms)
   å€™é€‰1: å›æ”¾ç´¢å¼•=5, å›æ”¾æ—¶é—´=(252.30ms, 352.20ms), æ€»è¯¯å·®=2.30ms
   å€™é€‰2: å›æ”¾ç´¢å¼•=8, å›æ”¾æ—¶é—´=(248.90ms, 348.70ms), æ€»è¯¯å·®=1.10ms
```

**æ³¨æ„**ï¼šæ€»è¯¯å·®ç°åœ¨åªä½¿ç”¨ `keyon_offset` çš„ç»å¯¹å€¼ï¼Œé˜ˆå€¼èŒƒå›´ä¸º30-50msã€‚

## 4. å¼‚å¸¸æ£€æµ‹é˜¶æ®µ

### 4.1 å¼‚å¸¸ç±»å‹å®šä¹‰

**ä¸¢é”¤ï¼ˆDrop Hammerï¼‰**ï¼šå½•åˆ¶æ•°æ®ä¸­æœ‰éŸ³ç¬¦ï¼Œä½†æ’­æ”¾æ•°æ®ä¸­æ²¡æœ‰å¯¹åº”çš„éŸ³ç¬¦
**å¤šé”¤ï¼ˆMulti Hammerï¼‰**ï¼šæ’­æ”¾æ•°æ®ä¸­æœ‰éŸ³ç¬¦ï¼Œä½†å½•åˆ¶æ•°æ®ä¸­æ²¡æœ‰å¯¹åº”çš„éŸ³ç¬¦
**ä¸å‘å£°ï¼ˆSilent Hammerï¼‰**ï¼šé”¤é€Ÿä¸º0æˆ–ç”µæœºé˜ˆå€¼æ£€æŸ¥å¤±è´¥çš„éŸ³ç¬¦

### 4.2 å¼‚å¸¸æ£€æµ‹æµç¨‹

**å¼‚å¸¸æ£€æµ‹æµç¨‹è¯¦ç»†è¯´æ˜**ï¼š

å¼‚å¸¸æ£€æµ‹é˜¶æ®µæ˜¯åˆ†ææµç¨‹çš„é‡è¦ç¯èŠ‚ï¼Œå…¶ç›®çš„æ˜¯è¯†åˆ«å’Œåˆ†æåŒ¹é…è¿‡ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µï¼ŒåŒ…æ‹¬ä¸¢é”¤ï¼ˆDrop Hammerï¼‰ã€å¤šé”¤ï¼ˆMulti Hammerï¼‰å’Œä¸å‘å£°ï¼ˆSilent Hammerï¼‰ä¸‰ç±»é—®é¢˜ã€‚æ£€æµ‹æµç¨‹é€šè¿‡`analyze_hammer_issues`æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šrecord_dataï¼ˆå½•åˆ¶æ•°æ®åˆ—è¡¨ï¼‰ã€replay_dataï¼ˆæ’­æ”¾æ•°æ®åˆ—è¡¨ï¼‰å’Œmatched_pairsï¼ˆå·²åŒ¹é…çš„éŸ³ç¬¦å¯¹åˆ—è¡¨ï¼‰ã€‚é¦–å…ˆï¼Œä»matched_pairsä¸­æå–æ‰€æœ‰å·²åŒ¹é…çš„å½•åˆ¶éŸ³ç¬¦ç´¢å¼•å’Œæ’­æ”¾éŸ³ç¬¦ç´¢å¼•ï¼Œåˆ†åˆ«å½¢æˆmatched_record_indiceså’Œmatched_replay_indicesä¸¤ä¸ªé›†åˆã€‚è¿™ä¸¤ä¸ªé›†åˆç”¨äºå¿«é€Ÿåˆ¤æ–­æŸä¸ªéŸ³ç¬¦æ˜¯å¦å·²è¢«æˆåŠŸåŒ¹é…ã€‚æ¥ä¸‹æ¥è¿›è¡Œä¸¢é”¤æ£€æµ‹ï¼ˆDrop Hammer Detectionï¼‰ï¼šéå†å½•åˆ¶æ•°æ®ï¼ˆrecord_dataï¼‰ä¸­çš„æ‰€æœ‰éŸ³ç¬¦ï¼Œæ£€æŸ¥æ¯ä¸ªéŸ³ç¬¦çš„ç´¢å¼•æ˜¯å¦åœ¨matched_record_indicesé›†åˆä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œè¯´æ˜è¯¥å½•åˆ¶éŸ³ç¬¦åœ¨æ’­æ”¾æ•°æ®ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå³å½•åˆ¶æ•°æ®ä¸­æœ‰éŸ³ç¬¦ä½†æ’­æ”¾æ•°æ®ä¸­æ²¡æœ‰ï¼Œè¿™è¢«ç§°ä¸º"ä¸¢é”¤"ã€‚å¯¹äºæ¯ä¸ªä¸¢é”¤éŸ³ç¬¦ï¼Œç³»ç»Ÿé€šè¿‡`_create_error_note`æ–¹æ³•åˆ›å»ºä¸€ä¸ªErrorNoteå¯¹è±¡ï¼ŒåŒ…å«éŸ³ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç´¢å¼•ã€é”®IDã€æŒ‰é”®å¼€å§‹/ç»“æŸæ—¶é—´ç­‰ï¼‰ï¼Œå¹¶å°†é”™è¯¯ç±»å‹è®¾ç½®ä¸º"ä¸¢é”¤"ï¼Œç„¶åæ·»åŠ åˆ°drop_hammersåˆ—è¡¨ä¸­ã€‚ç„¶åè¿›è¡Œå¤šé”¤æ£€æµ‹ï¼ˆMulti Hammer Detectionï¼‰ï¼šéå†æ’­æ”¾æ•°æ®ï¼ˆreplay_dataï¼‰ä¸­çš„æ‰€æœ‰éŸ³ç¬¦ï¼Œæ£€æŸ¥æ¯ä¸ªéŸ³ç¬¦çš„ç´¢å¼•æ˜¯å¦åœ¨matched_replay_indicesé›†åˆä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œè¯´æ˜è¯¥æ’­æ”¾éŸ³ç¬¦åœ¨å½•åˆ¶æ•°æ®ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå³æ’­æ”¾æ•°æ®ä¸­æœ‰éŸ³ç¬¦ä½†å½•åˆ¶æ•°æ®ä¸­æ²¡æœ‰ï¼Œè¿™è¢«ç§°ä¸º"å¤šé”¤"ã€‚å¯¹äºæ¯ä¸ªå¤šé”¤éŸ³ç¬¦ï¼ŒåŒæ ·åˆ›å»ºErrorNoteå¯¹è±¡ï¼Œè®¾ç½®é”™è¯¯ç±»å‹ä¸º"å¤šé”¤"ï¼Œå¹¶æ·»åŠ åˆ°multi_hammersåˆ—è¡¨ä¸­ã€‚ä¸å‘å£°æ£€æµ‹ï¼ˆSilent Hammer Detectionï¼‰åˆ™æ˜¯åœ¨è¿‡æ»¤é˜¶æ®µå®Œæˆçš„ï¼Œç›¸å…³ä¿¡æ¯å­˜å‚¨åœ¨invalid_countsçš„silent_notes_detailsä¸­ï¼Œé€šè¿‡`_extract_silent_hammers_from_invalid_counts`æ–¹æ³•æå–ã€‚æœ€ç»ˆè¿”å›drop_hammerså’Œmulti_hammersä¸¤ä¸ªåˆ—è¡¨ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨äºç”Ÿæˆé—®é¢˜åˆ—è¡¨è¡¨æ ¼ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½å’Œåˆ†æå¼‚å¸¸æƒ…å†µã€‚å¼‚å¸¸æ£€æµ‹ç»“æœè¿˜ä¼šä¸åŒ¹é…å¤±è´¥åŸå› ï¼ˆfailure_reasonsï¼‰ç»“åˆï¼Œåœ¨é—®é¢˜åˆ—è¡¨ä¸­æ˜¾ç¤ºè¯¦ç»†çš„å¤±è´¥åˆ†æåŸå› ï¼Œå¦‚"æ‰€æœ‰å€™é€‰å·²è¢«å ç”¨"æˆ–"æ—¶é—´è¯¯å·®è¿‡å¤§"ç­‰ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å…¨é¢çš„è¯Šæ–­ä¿¡æ¯ã€‚

**å…¥å£å‡½æ•°**ï¼š`spmid/error_detector.py:analyze_hammer_issues()`

```python
def analyze_hammer_issues(self, record_data: List[Note], replay_data: List[Note], matched_pairs: List[Tuple[int, int, Note, Note]]) -> Tuple[List[ErrorNote], List[ErrorNote]]:
    """åˆ†æé”¤å­é—®é¢˜ï¼šä¸¢é”¤å’Œå¤šé”¤"""

    # 1. è·å–å·²åŒ¹é…çš„éŸ³ç¬¦ç´¢å¼•
    matched_record_indices = set(pair[0] for pair in matched_pairs)
    matched_replay_indices = set(pair[1] for pair in matched_pairs)

    # 2. è¯†åˆ«ä¸¢é”¤ï¼ˆå½•åˆ¶æœ‰ï¼Œæ’­æ”¾æ— ï¼‰
    drop_hammers = []
    for i, note in enumerate(record_data):
        if i not in matched_record_indices:
            error_note = self._create_error_note(note, i, "ä¸¢é”¤")
            drop_hammers.append(error_note)

    # 3. è¯†åˆ«å¤šé”¤ï¼ˆæ’­æ”¾æœ‰ï¼Œå½•åˆ¶æ— ï¼‰
    multi_hammers = []
    for i, note in enumerate(replay_data):
        if i not in matched_replay_indices:
            error_note = self._create_error_note(note, i, "å¤šé”¤")
            multi_hammers.append(error_note)

    return drop_hammers, multi_hammers
```

### 4.3 ä¸å‘å£°æ£€æµ‹

**å®ç°ä½ç½®**ï¼š`spmid/spmid_analyzer.py:_extract_silent_hammers_from_invalid_counts()`

```python
def _extract_silent_hammers_from_invalid_counts(self, invalid_counts: Dict[str, Any]) -> List[ErrorNote]:
    """ä»è¿‡æ»¤ç»“æœä¸­æå–ä¸å‘å£°çš„éŸ³ç¬¦è¯¦æƒ…"""

    silent_hammers = []

    # å¤„ç†å½•åˆ¶å’Œæ’­æ”¾æ•°æ®ä¸­çš„ä¸å‘å£°éŸ³ç¬¦
    for data_type in ['record_data', 'replay_data']:
        silent_details = invalid_counts.get(data_type, {}).get('silent_notes_details', [])

        for item in silent_details:
            note = item['note']
            index = item['index']

            # è®¡ç®—æ—¶é—´ä¿¡æ¯
            keyon_time = note.after_touch.index[0] + note.offset if len(note.after_touch) > 0 else 0
            keyoff_time = note.after_touch.index[-1] + note.offset if len(note.after_touch) > 0 else 0

            # åˆ›å»ºé”™è¯¯éŸ³ç¬¦å¯¹è±¡
            error_note = ErrorNote(
                infos=[NoteInfo(index=index, keyId=note.id, keyOn=keyon_time, keyOff=keyoff_time)],
                diffs=[],
                error_type="ä¸å‘å£°",
                global_index=index
            )
            silent_hammers.append(error_note)

    return silent_hammers
```

## 5. ç»Ÿè®¡åˆ†æé˜¶æ®µ

### 5.1 åç§»å¯¹é½æ•°æ®è®¡ç®—

**åç§»å¯¹é½è®¡ç®—è¯¦ç»†è¯´æ˜**ï¼š

åç§»å¯¹é½æ•°æ®è®¡ç®—æ˜¯ç»Ÿè®¡åˆ†æé˜¶æ®µçš„ç¬¬ä¸€æ­¥ï¼Œå…¶ç›®çš„æ˜¯ä¸ºæ¯ä¸ªæˆåŠŸåŒ¹é…çš„éŸ³ç¬¦å¯¹è®¡ç®—è¯¦ç»†çš„æ—¶é—´åç§»ä¿¡æ¯ï¼Œä¸ºåç»­çš„ç»Ÿè®¡åˆ†æå’Œå¯è§†åŒ–æä¾›æ•°æ®åŸºç¡€ã€‚è®¡ç®—è¿‡ç¨‹é€šè¿‡`get_offset_alignment_data`æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•éå†æ‰€æœ‰å·²åŒ¹é…çš„éŸ³ç¬¦å¯¹ï¼ˆmatched_pairsï¼‰ã€‚å¯¹äºæ¯ä¸€å¯¹åŒ¹é…çš„éŸ³ç¬¦ï¼ˆrecord_noteå’Œreplay_noteï¼‰ï¼Œé¦–å…ˆé€šè¿‡`_calculate_note_times`æ–¹æ³•è®¡ç®—ä¸¤ä¸ªéŸ³ç¬¦çš„å…³é”®æ—¶é—´ç‚¹ï¼šå½•åˆ¶éŸ³ç¬¦çš„æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆrecord_keyon = record_note.after_touch.index[0] + record_note.offsetï¼‰å’ŒæŒ‰é”®ç»“æŸæ—¶é—´ï¼ˆrecord_keyoff = record_note.after_touch.index[-1] + record_note.offsetï¼‰ï¼Œæ’­æ”¾éŸ³ç¬¦çš„æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆreplay_keyon = replay_note.after_touch.index[0] + replay_note.offsetï¼‰å’ŒæŒ‰é”®ç»“æŸæ—¶é—´ï¼ˆreplay_keyoff = replay_note.after_touch.index[-1] + replay_note.offsetï¼‰ã€‚æ‰€æœ‰æ—¶é—´å€¼å‡ä»¥0.1msä¸ºå•ä½ï¼Œæ˜¯ç»å¯¹æ—¶é—´æˆ³ã€‚æ¥ä¸‹æ¥è®¡ç®—åç§»é‡ï¼škeyon_offset = replay_keyon - record_keyonï¼ˆæ’­æ”¾æŒ‰é”®å¼€å§‹æ—¶é—´ç›¸å¯¹äºå½•åˆ¶æŒ‰é”®å¼€å§‹æ—¶é—´çš„åç§»ï¼‰ï¼Œè¿™ä¸ªå€¼å¯ä»¥ä¸ºæ­£ï¼ˆæ’­æ”¾å»¶è¿Ÿï¼‰æˆ–è´Ÿï¼ˆæ’­æ”¾æå‰ï¼‰ã€‚åŒæ—¶è®¡ç®—æŒç»­æ—¶é—´ï¼šrecord_duration = record_keyoff - record_keyonï¼ˆå½•åˆ¶éŸ³ç¬¦çš„æŒç»­æ—¶é—´ï¼‰ï¼Œreplay_duration = replay_keyoff - replay_keyonï¼ˆæ’­æ”¾éŸ³ç¬¦çš„æŒç»­æ—¶é—´ï¼‰ï¼Œä»¥åŠæŒç»­æ—¶é—´å·®ï¼šduration_offset = replay_duration - record_durationï¼ˆæ’­æ”¾æŒç»­æ—¶é—´ç›¸å¯¹äºå½•åˆ¶æŒç»­æ—¶é—´çš„å˜åŒ–ï¼‰ã€‚è™½ç„¶duration_offsetä¼šè¢«è®¡ç®—å’Œä¿å­˜ï¼Œä½†å½“å‰ç³»ç»Ÿçš„average_offsetåªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼ï¼šavg_offset = |keyon_offset|ã€‚è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯èŠ‚å¥å¯¹é½ï¼ˆkeyonæ—¶æœºï¼‰åœ¨é’¢ç´æ¼”å¥ä¸­å æ®ä¸»å¯¼åœ°ä½ï¼Œå¬æ„Ÿä¸Šæ›´æ•æ„Ÿï¼Œè€Œdurationå·®å¼‚è™½ç„¶ä¹Ÿé‡è¦ï¼Œä½†ä¸»è¦ç”¨äºå½¢æ€åˆ†æï¼Œä¸å‚ä¸åŒ¹é…å†³ç­–å’Œå…¨å±€å¹³å‡æ—¶å»¶çš„ç»Ÿè®¡è®¡ç®—ï¼Œé¿å…å£å¾„æ··æ‚ã€‚æœ€ç»ˆï¼Œä¸ºæ¯ä¸ªåŒ¹é…å¯¹ç”Ÿæˆä¸€ä¸ªåŒ…å«å®Œæ•´ä¿¡æ¯çš„å­—å…¸ï¼ŒåŒ…æ‹¬ï¼šrecord_indexï¼ˆå½•åˆ¶éŸ³ç¬¦ç´¢å¼•ï¼‰ã€replay_indexï¼ˆæ’­æ”¾éŸ³ç¬¦ç´¢å¼•ï¼‰ã€key_idï¼ˆé”®IDï¼‰ã€record_keyon/keyoffï¼ˆå½•åˆ¶æ—¶é—´ç‚¹ï¼‰ã€replay_keyon/keyoffï¼ˆæ’­æ”¾æ—¶é—´ç‚¹ï¼‰ã€keyon_offsetï¼ˆæŒ‰é”®å¼€å§‹æ—¶é—´åç§»ï¼‰ã€duration_offsetï¼ˆæŒç»­æ—¶é—´å·®ï¼‰ã€average_offsetï¼ˆå¹³å‡åç§»ï¼Œå³|keyon_offset|ï¼‰ã€record_duration/replay_durationï¼ˆæŒç»­æ—¶é—´ï¼‰ç­‰ã€‚æ‰€æœ‰è¿™äº›æ•°æ®éƒ½ä»¥0.1msä¸ºå•ä½ï¼Œåœ¨UIå±•ç¤ºæ—¶æ‰ä¼šè½¬æ¢ä¸ºmsã€‚åç§»å¯¹é½æ•°æ®å°†ç”¨äºç”Ÿæˆåç§»å¯¹é½åˆ†æè¡¨æ ¼ã€è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸­ä½æ•°ã€å‡å€¼ã€æ ‡å‡†å·®ï¼‰ä»¥åŠè®¡ç®—å…¨å±€å¹³å‡æ—¶å»¶ã€‚

**æ ¸å¿ƒå‡½æ•°**ï¼š`spmid/note_matcher.py:get_offset_alignment_data()`

è®¡ç®—æ¯ä¸ªåŒ¹é…å¯¹çš„æ—¶é—´åç§»ä¿¡æ¯ï¼Œåªä½¿ç”¨ `keyon_offset` è®¡ç®— `average_offset`ã€‚

```python
def get_offset_alignment_data(self) -> List[Dict[str, Any]]:
    """è·å–åç§»å¯¹é½æ•°æ® - è®¡ç®—æ¯ä¸ªåŒ¹é…å¯¹çš„æ—¶é—´åç§»"""

    offset_data = []

    for record_idx, replay_idx, record_note, replay_note in self.matched_pairs:
        # è®¡ç®—å½•åˆ¶å’Œæ’­æ”¾éŸ³ç¬¦çš„æ—¶é—´
        record_keyon, record_keyoff = self._calculate_note_times(record_note)
        replay_keyon, replay_keyoff = self._calculate_note_times(replay_note)

        # è®¡ç®—åç§»é‡ï¼šåªä½¿ç”¨keyon_offset
        keyon_offset = replay_keyon - record_keyon
        record_duration = record_keyoff - record_keyon
        replay_duration = replay_keyoff - replay_keyon
        duration_offset = replay_duration - record_duration

        # åªä½¿ç”¨keyon_offsetè®¡ç®—average_offset
        avg_offset = abs(keyon_offset)

        offset_data.append({
            'record_index': record_idx,
            'replay_index': replay_idx,
            'key_id': record_note.id,
            'record_keyon': record_keyon,
            'replay_keyon': replay_keyon,
            'keyon_offset': keyon_offset,
            'record_keyoff': record_keyoff,
            'replay_keyoff': replay_keyoff,
            'duration_offset': duration_offset,
            'average_offset': avg_offset,  # åªä½¿ç”¨keyon_offset
            'record_duration': record_duration,
            'replay_duration': replay_duration
        })

    return offset_data
```

### 5.2 åç§»ç»Ÿè®¡è®¡ç®—

**åç§»ç»Ÿè®¡è®¡ç®—è¯¦ç»†è¯´æ˜**ï¼š

åç§»ç»Ÿè®¡è®¡ç®—æ˜¯å¯¹åç§»å¯¹é½æ•°æ®è¿›è¡Œèšåˆåˆ†æçš„è¿‡ç¨‹ï¼Œå…¶ç›®çš„æ˜¯ä»æ•´ä½“ä¸Šäº†è§£åŒ¹é…éŸ³ç¬¦å¯¹çš„æ—¶é—´åç§»ç‰¹å¾ï¼Œä¸ºæ€§èƒ½è¯„ä¼°å’Œé—®é¢˜è¯Šæ–­æä¾›ç»Ÿè®¡ä¾æ®ã€‚è®¡ç®—è¿‡ç¨‹é€šè¿‡`get_offset_statistics`æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²åŒ¹é…çš„éŸ³ç¬¦å¯¹ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…å¯¹åˆ™è¿”å›ç©ºçš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ‰€æœ‰ç»Ÿè®¡å€¼å‡ä¸º0.0ï¼‰ã€‚å¦‚æœæœ‰åŒ¹é…å¯¹ï¼Œåˆ™å…ˆè°ƒç”¨`get_offset_alignment_data`è·å–æ‰€æœ‰åŒ¹é…å¯¹çš„åç§»å¯¹é½æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œä»åç§»å¯¹é½æ•°æ®ä¸­æå–ä¸‰ç±»åç§»å€¼åˆ—è¡¨ï¼šç¬¬ä¸€ç±»æ˜¯keyon_offsetsï¼Œç›´æ¥ä»æ¯é¡¹çš„'keyon_offset'å­—æ®µæå–ï¼ˆè¿™äº›å€¼å¯ä»¥ä¸ºæ­£æˆ–è´Ÿï¼Œè¡¨ç¤ºæ’­æ”¾ç›¸å¯¹äºå½•åˆ¶çš„æå‰æˆ–å»¶è¿Ÿï¼‰ï¼›ç¬¬äºŒç±»æ˜¯duration_offsetsï¼Œä»æ¯é¡¹çš„'duration_offset'å­—æ®µæå–ï¼ˆè¡¨ç¤ºæŒç»­æ—¶é—´çš„å˜åŒ–ï¼Œæ­£å€¼ä¸ºæ’­æ”¾æŒç»­æ—¶é—´æ›´é•¿ï¼Œè´Ÿå€¼ä¸ºæ’­æ”¾æŒç»­æ—¶é—´æ›´çŸ­ï¼‰ï¼›ç¬¬ä¸‰ç±»æ˜¯overall_offsetsï¼Œæå–æ¯é¡¹çš„'keyon_offset'çš„ç»å¯¹å€¼ï¼ˆå³|keyon_offset|ï¼‰ï¼Œç”¨äºæ•´ä½“ç»Ÿè®¡ã€‚æ³¨æ„ï¼šè™½ç„¶duration_offsetsä¼šè¢«æå–å’Œç»Ÿè®¡ï¼Œä½†overall_offset_statsï¼ˆæ•´ä½“åç§»ç»Ÿè®¡ï¼‰åªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼ï¼Œä¸æ··å…¥durationåå·®ï¼Œè¿™ç¡®ä¿äº†ç»Ÿè®¡å£å¾„çš„æ¸…æ™°æ€§å’Œä¸€è‡´æ€§ã€‚å¯¹äºæ¯ä¸ªåç§»å€¼åˆ—è¡¨ï¼Œç³»ç»Ÿè°ƒç”¨`_calculate_offset_stats`æ–¹æ³•è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šaverageï¼ˆå¹³å‡å€¼ï¼Œå³ç®—æœ¯å¹³å‡ï¼‰ã€maxï¼ˆæœ€å¤§å€¼ï¼‰ã€minï¼ˆæœ€å°å€¼ï¼‰ã€stdï¼ˆæ ‡å‡†å·®ï¼Œç”¨äºè¡¡é‡æ•°æ®çš„ç¦»æ•£ç¨‹åº¦ï¼‰ã€‚`_calculate_offset_stats`æ–¹æ³•ä½¿ç”¨æ ·æœ¬æ ‡å‡†å·®å…¬å¼ï¼šstd = sqrt(sum((x - average)^2) / (n - 1))ï¼Œå…¶ä¸­nä¸ºæ•°æ®ç‚¹çš„æ•°é‡ã€‚æ³¨æ„ï¼š`get_offset_statistics`è¿”å›çš„æ ‡å‡†å·®ä½¿ç”¨æ ·æœ¬å®šä¹‰ï¼ˆn-1ï¼‰ï¼Œè€Œæ•°æ®æ¦‚è§ˆé¡µé¢æ˜¾ç¤ºçš„æ€»ä½“æ ‡å‡†å·®ä½¿ç”¨`get_standard_deviation()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨æ€»ä½“å®šä¹‰ï¼ˆnï¼‰ä¸”åŸºäºç»å¯¹è¯¯å·®è®¡ç®—ã€‚æœ€ç»ˆè¿”å›ä¸€ä¸ªåŒ…å«æ€»åŒ¹é…å¯¹æ•°ï¼ˆtotal_pairsï¼‰å’Œä¸‰ç±»ç»Ÿè®¡ä¿¡æ¯ï¼ˆkeyon_offset_statsã€duration_offset_statsã€overall_offset_statsï¼‰çš„å­—å…¸ã€‚è¿™äº›ç»Ÿè®¡ä¿¡æ¯å°†è¢«ç”¨äºç”Ÿæˆæ•°æ®ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ï¼Œåœ¨UIä¸­å±•ç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£æ•´ä½“åŒ¹é…è´¨é‡å’Œæ—¶é—´åç§»ç‰¹å¾ã€‚

**æ ¸å¿ƒå‡½æ•°**ï¼š`spmid/note_matcher.py:get_offset_statistics()`

```python
def get_offset_statistics(self) -> Dict[str, Any]:
    """è·å–åç§»ç»Ÿè®¡ä¿¡æ¯"""

    if not self.matched_pairs:
        return {
            'total_pairs': 0,
            'keyon_offset_stats': {'average': 0.0, 'max': 0.0, 'min': 0.0, 'std': 0.0},
            'duration_offset_stats': {'average': 0.0, 'max': 0.0, 'min': 0.0, 'std': 0.0},
            'overall_offset_stats': {'average': 0.0, 'max': 0.0, 'min': 0.0, 'std': 0.0}
        }

    # è·å–åç§»æ•°æ®
    offset_data = self.get_offset_alignment_data()

    # æå–åç§»å€¼ï¼ˆåªä½¿ç”¨keyon_offsetï¼‰
    keyon_offsets = [item['keyon_offset'] for item in offset_data]
    duration_offsets = [item.get('duration_offset', 0.0) for item in offset_data]
    # æ•´ä½“ç»Ÿè®¡åªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼
    overall_offsets = [abs(item.get('keyon_offset', 0)) for item in offset_data if item.get('keyon_offset') is not None]

    return {
        'total_pairs': len(self.matched_pairs),
        'keyon_offset_stats': self._calculate_offset_stats(keyon_offsets),
        'duration_offset_stats': self._calculate_offset_stats(duration_offsets),
        'overall_offset_stats': self._calculate_offset_stats(overall_offsets)  # åªä½¿ç”¨keyon_offset
    }
```

### 5.3 å…¨å±€å¹³å‡æ—¶å»¶è®¡ç®—

**å…¨å±€å¹³å‡æ—¶å»¶è®¡ç®—è¯¦ç»†è¯´æ˜**ï¼š

å…¨å±€å¹³å‡æ—¶å»¶æ˜¯ç³»ç»Ÿæœ€é‡è¦çš„æ€§èƒ½æŒ‡æ ‡ä¹‹ä¸€ï¼Œç”¨äºè¯„ä¼°æ•´é¦–æ›²å­çš„æ€»ä½“æ—¶é—´å¯¹é½è´¨é‡ã€‚è®¡ç®—è¿‡ç¨‹é€šè¿‡`get_global_average_delay`æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²åŒ¹é…çš„éŸ³ç¬¦å¯¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è¿”å›0.0ã€‚å¦‚æœæœ‰åŒ¹é…å¯¹ï¼Œåˆ™è°ƒç”¨`get_offset_alignment_data`æ–¹æ³•è·å–æ‰€æœ‰åŒ¹é…å¯¹çš„åç§»å¯¹é½æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œä»åç§»å¯¹é½æ•°æ®ä¸­æå–æ‰€æœ‰keyon_offsetçš„ç»å¯¹å€¼ï¼Œå½¢æˆkeyon_errorsåˆ—è¡¨ï¼Œå³[abs(item['keyon_offset']) for item in offset_data]ã€‚æ³¨æ„ï¼šç³»ç»Ÿåªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼è®¡ç®—å…¨å±€å¹³å‡æ—¶å»¶ï¼Œä¸ä½¿ç”¨duration_offsetï¼Œä¹Ÿä¸ä½¿ç”¨åŠ æƒå¹³å‡ï¼Œè¿™ç¡®ä¿äº†æŒ‡æ ‡å£å¾„çš„ç®€æ´æ€§å’Œå¯è§£é‡Šæ€§ã€‚åŸå› åœ¨äºèŠ‚å¥å¯¹é½ï¼ˆkeyonæ—¶æœºï¼‰åœ¨é’¢ç´æ¼”å¥ä¸­å æ®ä¸»å¯¼åœ°ä½ï¼Œæ˜¯å½±å“å¬æ„Ÿçš„å…³é”®å› ç´ ï¼Œè€Œdurationå·®å¼‚è™½ç„¶ä¹Ÿé‡è¦ï¼Œä½†ä¸»è¦ç”¨äºå½¢æ€åˆ†æï¼Œä¸å‚ä¸å…¨å±€æ€§èƒ½è¯„ä¼°ã€‚å¦‚æœkeyon_errorsåˆ—è¡¨ä¸ºç©ºï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä»£ç åšäº†é˜²å¾¡æ€§æ£€æŸ¥ï¼‰ï¼Œåˆ™è¿”å›0.0ã€‚å¦åˆ™ï¼Œè®¡ç®—ç®—æœ¯å¹³å‡å€¼ï¼šaverage_delay = sum(keyon_errors) / len(keyon_errors)ï¼Œå•ä½ä»ç„¶æ˜¯0.1msã€‚è®¡ç®—å®Œæˆåï¼Œè®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¹³å‡æ—¶å»¶ï¼ˆè½¬æ¢ä¸ºmsæ˜¾ç¤ºï¼‰å’ŒåŸºäºçš„åŒ¹é…å¯¹æ•°é‡ã€‚æœ€ç»ˆè¿”å›average_delayï¼ˆ0.1mså•ä½ï¼‰ï¼Œè¯¥å€¼å°†è¢«åç«¯å±‚æ¥æ”¶å¹¶åŸæ ·ä¼ é€’ç»™UIå±‚ï¼ŒUIå±‚åœ¨æ˜¾ç¤ºæ—¶é™¤ä»¥10è½¬æ¢ä¸ºmså•ä½ã€‚å…¨å±€å¹³å‡æ—¶å»¶çš„è®¡ç®—è°ƒç”¨é“¾ä¸ºï¼šUIå±‚è°ƒç”¨Backendçš„`get_global_average_delay()`ï¼ŒBackendè°ƒç”¨Analyzerçš„`get_global_average_delay()`ï¼ŒAnalyzerè°ƒç”¨NoteMatcherçš„`get_global_average_delay()`ï¼ŒNoteMatcherå†…éƒ¨è°ƒç”¨`get_offset_alignment_data()`è·å–åç§»æ•°æ®ï¼Œç„¶åæå–å¹¶è®¡ç®—å¹³å‡å€¼ï¼Œæœ€ç»ˆæŒ‰åŸè·¯è¿”å›ã€‚æ•´ä¸ªè¿‡ç¨‹ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆå†…éƒ¨0.1mså•ä½ï¼‰å’Œæ˜¾ç¤ºçš„ç”¨æˆ·å‹å¥½æ€§ï¼ˆUIå±‚mså•ä½ï¼‰ã€‚

**è°ƒç”¨é“¾è¯´æ˜**ï¼š

å…¨å±€å¹³å‡æ—¶å»¶çš„è®¡ç®—æ¶‰åŠå¤šå±‚è°ƒç”¨ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š1) UIå±‚ï¼ˆDashç•Œé¢ï¼‰éœ€è¦æ˜¾ç¤ºå¹³å‡æ—¶å»¶æ—¶ï¼Œè°ƒç”¨åç«¯PianoAnalysisBackendçš„`get_global_average_delay()`æ–¹æ³•ï¼›2) åç«¯å±‚æ¥æ”¶è¯·æ±‚åï¼Œç›´æ¥è°ƒç”¨SPMIDAnalyzerçš„`get_global_average_delay()`æ–¹æ³•ï¼Œä¸åšä»»ä½•å•ä½è½¬æ¢ï¼Œä¿æŒ0.1mså†…éƒ¨å•ä½ï¼›3) SPMIDAnalyzerä½œä¸ºåè°ƒå™¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰NoteMatcherå®ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨NoteMatcherçš„`get_global_average_delay()`æ–¹æ³•ï¼Œå¦åˆ™è¿”å›0.0ï¼›4) NoteMatcheræ‰§è¡Œå®é™…è®¡ç®—ï¼šé¦–å…ˆè°ƒç”¨è‡ªèº«çš„`get_offset_alignment_data()`æ–¹æ³•è·å–æ‰€æœ‰åŒ¹é…å¯¹çš„åç§»å¯¹é½æ•°æ®ï¼Œè¯¥æ–¹æ³•éå†matched_pairsï¼Œä¸ºæ¯å¯¹è®¡ç®—keyon_offsetã€duration_offsetç­‰ï¼Œå¹¶ç”Ÿæˆå®Œæ•´çš„åç§»æ•°æ®åˆ—è¡¨ï¼›ç„¶åä»åç§»æ•°æ®ä¸­æå–æ‰€æœ‰keyon_offsetçš„ç»å¯¹å€¼ï¼Œå½¢æˆkeyon_errorsåˆ—è¡¨ï¼›è®¡ç®—ç®—æœ¯å¹³å‡å€¼average_delay = sum(keyon_errors) / len(keyon_errors)ï¼Œå•ä½0.1msï¼›è®°å½•æ—¥å¿—ï¼›è¿”å›average_delayï¼›5) è¿”å›å€¼æŒ‰åŸè·¯å¾„è¿”å›ï¼šNoteMatcher â†’ SPMIDAnalyzer â†’ PianoAnalysisBackend â†’ UIå±‚ï¼›6) UIå±‚æ¥æ”¶åˆ°0.1mså•ä½çš„å€¼åï¼Œåœ¨æ˜¾ç¤ºæ—¶é™¤ä»¥10è½¬æ¢ä¸ºmså•ä½ï¼Œå±•ç¤ºç»™ç”¨æˆ·ã€‚æ•´ä¸ªè°ƒç”¨é“¾ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆå†…éƒ¨è®¡ç®—å…¨ç¨‹ä½¿ç”¨0.1msï¼‰å’Œæ˜¾ç¤ºçš„ç”¨æˆ·å‹å¥½æ€§ï¼ˆUIå±‚ç»Ÿä¸€è½¬æ¢ä¸ºmsï¼‰ï¼Œé¿å…äº†å¤šæ¬¡å•ä½è½¬æ¢å¯¼è‡´çš„æ•°æ®ç²¾åº¦æŸå¤±ã€‚

**æ ¸å¿ƒå‡½æ•°**ï¼š`spmid/note_matcher.py:get_global_average_delay()`

```python
def get_global_average_delay(self) -> float:
    """è®¡ç®—æ•´é¦–æ›²å­çš„å¹³å‡æ—¶å»¶ï¼ˆåŸºäºå·²é…å¯¹æ•°æ®ï¼‰

    åªä½¿ç”¨ keyon_offset è®¡ç®—ï¼šå…¨å±€å¹³å‡æ—¶å»¶ = mean(|keyon_offset|)
    """

    if not self.matched_pairs:
        return 0.0

    # è·å–åç§»æ•°æ®
    offset_data = self.get_offset_alignment_data()

    # åªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼
    keyon_errors = [abs(item.get('keyon_offset', 0)) for item in offset_data if item.get('keyon_offset') is not None]

    if not keyon_errors:
        return 0.0

    # è®¡ç®—å¹³å‡å€¼ï¼ˆ0.1mså•ä½ï¼‰
    average_delay = sum(keyon_errors) / len(keyon_errors)

    logger.info(f"ğŸ“Š æ•´é¦–æ›²å­å¹³å‡æ—¶å»¶(keyon): {average_delay/10:.2f}ms (åŸºäº{len(keyon_errors)}ä¸ªåŒ¹é…å¯¹)")

    return average_delay  # è¿”å›0.1mså•ä½
```

### 5.4 è¯„ä»·æŒ‡æ ‡ä¸ç»Ÿè®¡å£å¾„ï¼ˆå«æ•°å­¦å…¬å¼ï¼‰

æœ¬èŠ‚ç»Ÿä¸€ç»™å‡ºå„è¯„ä»·æŒ‡æ ‡çš„å®šä¹‰ã€å…¬å¼ã€å•ä½å’Œæ•°æ®å£å¾„ï¼Œç¡®ä¿ç»Ÿè®¡å«ä¹‰ä¸€è‡´ä¸”å¯å¤ç°ã€‚

#### æ•°æ®å£å¾„ï¼ˆç»Ÿä¸€è¯´æ˜ï¼‰

- ä»…ä½¿ç”¨"å·²åŒ¹é…æŒ‰é”®å¯¹"ï¼ˆmatched_pairsï¼‰ã€‚

- å•ä¸ªæ ·æœ¬çš„å¸¦ç¬¦å·åå·®å®šä¹‰ä¸ºï¼š
  
  $$
  ( x_i = \mathrm{replay\_keyon}_i - \mathrm{record\_keyon}_i)ï¼ˆå†…éƒ¨å•ä½0.1msï¼Œå±•ç¤ºæ—¶é™¤ä»¥10ä¸ºmsï¼‰ã€‚
  $$

- ä¸çº³å…¥æœªåŒ¹é…æ ·æœ¬ï¼ˆä¸¢é”¤/å¤šé”¤/ä¸å‘å£°ï¼‰ã€‚

#### è¯„ä»·æŒ‡æ ‡è¯¦ç»†è¯´æ˜

ç³»ç»Ÿæä¾›ä»¥ä¸‹è¯„ä»·æŒ‡æ ‡ï¼Œç”¨äºå…¨é¢è¯„ä¼°å»¶æ—¶å¯¹é½è´¨é‡ã€‚æ‰€æœ‰æŒ‡æ ‡å‡åŸºäºå·²åŒ¹é…æŒ‰é”®å¯¹ï¼ˆmatched_pairsï¼‰è®¡ç®—ã€‚

**ç¬¦å·å®šä¹‰**ï¼š



$$
è®¾ ( n ) ä¸ºå·²åŒ¹é…æŒ‰é”®å¯¹çš„æ•°é‡ï¼Œ( i \in \{1, 2, \ldots, n\} ) ä¸ºåŒ¹é…å¯¹ç´¢å¼•ã€‚
$$

å¯¹äºç¬¬ \( i \) ä¸ªåŒ¹é…å¯¹ï¼Œå®šä¹‰ï¼š

$$
( t_{\text{record},i})ï¼šå½•åˆ¶æ•°æ®çš„æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆå•ä½ï¼š0.1msï¼‰
$$

$$
( t_{\text{replay},i})ï¼šæ’­æ”¾æ•°æ®çš„æŒ‰é”®å¼€å§‹æ—¶é—´ï¼ˆå•ä½ï¼š0.1msï¼‰
$$

$$
( x_i = t_{\text{replay},i} - t_{\text{record},i})ï¼šå¸¦ç¬¦å·çš„æ—¶é—´åç§»é‡ï¼ˆå•ä½ï¼š0.1msï¼‰
$$

$$
( y_i = |x_i|)ï¼šç»å¯¹æ—¶é—´åç§»é‡ï¼ˆå•ä½ï¼š0.1msï¼‰
$$

**æŒ‡æ ‡åˆ†ç±»**ï¼š

æ ¹æ®åˆ†æç›®æ ‡ï¼ŒæŒ‡æ ‡åˆ†ä¸ºä¸¤ç±»ï¼š

1. **ç”¨äº"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"åˆ†æ**ï¼šä½¿ç”¨ç»å¯¹è¯¯å·® \( y_i \)ï¼Œå…³æ³¨è¯¯å·®å¤§å°ï¼Œä¸è€ƒè™‘æå‰/æ»åæ–¹å‘
2. **ç”¨äºç³»ç»Ÿæ€§åå·®åˆ†æ**ï¼šä½¿ç”¨å¸¦ç¬¦å·å€¼ \( x_i \)ï¼Œåæ˜ æ•´ä½“æå‰/æ»åæ–¹å‘æ€§

---

##### 1. æ€»ä½“å‡å€¼ï¼ˆPopulation Meanï¼‰

- **å®šä¹‰**ï¼šæ‰€æœ‰å·²åŒ¹é…æŒ‰é”®å¯¹çš„ keyon_offset çš„ç®—æœ¯å¹³å‡ï¼Œåæ˜ æ•´ä½“æå‰/æ»åæ–¹å‘æ€§
- **ç”¨é€”**ï¼šåˆ†æç³»ç»Ÿæ€§åå·®ï¼ˆæ­£å€¼è¡¨ç¤º replay æ•´ä½“å»¶è¿Ÿï¼Œè´Ÿå€¼è¡¨ç¤º replay æ•´ä½“æå‰ï¼‰
- $$
  å…¬å¼ï¼š \mu = \frac{1}{n} \sum_{i=1}^{n} x_i = \frac{1}{n} \sum_{i=1}^{n} (t_{\text{replay},i} - t_{\text{record},i})
  $$
- **æ•°æ®æ¥æº**ï¼šä½¿ç”¨å¸¦ç¬¦å·çš„ `keyon_offset`ï¼ˆå³ \( x_i \)ï¼Œå¯èƒ½ä¸ºæ­£æˆ–è´Ÿï¼‰
- **å•ä½**ï¼šå†…éƒ¨ 0.1msï¼›UI æ˜¾ç¤º msï¼ˆÃ·10ï¼‰
- **ä»£ç å®ç°**ï¼š`spmid/note_matcher.py:get_mean_error()`
- **UIæ˜¾ç¤º**ï¼šæ•°æ®æ¦‚è§ˆé¡µé¢çš„"æ€»ä½“å‡å€¼"

---

##### 2. å¹³å‡ç»å¯¹è¯¯å·®ï¼ˆMAEï¼ŒMean Absolute Errorï¼‰ / å¹³å‡å»¶æ—¶

- **å®šä¹‰**ï¼šåå·®ç»å¯¹å€¼çš„å¹³å‡ï¼Œè¡¡é‡å¹³å‡åå·®è§„æ¨¡ï¼Œä¸è€ƒè™‘æ–¹å‘æ€§
- **ç”¨é€”**ï¼šç”¨äº"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"åˆ†æï¼Œåæ˜ è¯¯å·®å¤§å°
- **æ•°å­¦å…¬å¼**ï¼š
  \[
  \mathrm{MAE} = \frac{1}{n} \sum_{i=1}^{n} y_i = \frac{1}{n} \sum_{i=1}^{n} |x_i| = \frac{1}{n} \sum_{i=1}^{n} |t_{\text{replay},i} - t_{\text{record},i}|
  \]
- **æ•°æ®æ¥æº**ï¼šä½¿ç”¨ç»å¯¹å€¼çš„ `keyon_offset`ï¼ˆå³ \( y_i = |x_i| \)ï¼‰
- **å•ä½**ï¼šå†…éƒ¨ 0.1msï¼›UI æ˜¾ç¤º msï¼ˆÃ·10ï¼‰
- **ä»£ç å®ç°**ï¼š`spmid/note_matcher.py:get_mean_absolute_error()`
- **UIæ˜¾ç¤º**ï¼šæ•°æ®æ¦‚è§ˆé¡µé¢çš„"å¹³å‡å»¶æ—¶ï¼ˆç»å¯¹å€¼å£å¾„ï¼Œç­‰åŒMAEï¼‰"
- **è¯´æ˜**ï¼šä¸æ€»ä½“å‡å€¼çš„åŒºåˆ«åœ¨äºï¼ŒMAE ä¸è€ƒè™‘æ–¹å‘æ€§ï¼Œåªåæ˜ è¯¯å·®çš„å¹…åº¦å¤§å°

---

##### 3. å‡æ–¹è¯¯å·®ï¼ˆMSEï¼ŒMean Squared Errorï¼‰

- **å®šä¹‰**ï¼šåå·®å¹³æ–¹çš„å¹³å‡ï¼Œå¯¹å¤§åå·®æ›´æ•æ„Ÿ
- **ç”¨é€”**ï¼šåˆ†æè¯¯å·®çš„å¹³æ–¹ç‰¹æ€§ï¼Œå¯¹å¤§åå·®ç»™äºˆæ›´é«˜æƒé‡
- **æ•°å­¦å…¬å¼**ï¼š
  \[
  \mathrm{MSE} = \frac{1}{n} \sum_{i=1}^{n} x_i^2 = \frac{1}{n} \sum_{i=1}^{n} (t_{\text{replay},i} - t_{\text{record},i})^2
  \]
- **æ•°æ®æ¥æº**ï¼šä½¿ç”¨å¸¦ç¬¦å·çš„ `keyon_offset` çš„å¹³æ–¹ï¼ˆå³ \( x_i^2 \)ï¼‰
- **å•ä½**ï¼šå†…éƒ¨ (0.1ms)Â²ï¼›UI æ˜¾ç¤º msÂ²ï¼ˆÃ·100ï¼‰
- **ä»£ç å®ç°**ï¼š`spmid/note_matcher.py:get_mean_squared_error()`
- **UIæ˜¾ç¤º**ï¼šæ•°æ®æ¦‚è§ˆé¡µé¢çš„"å‡æ–¹è¯¯å·®(MSE)"

---

##### 4. æ€»ä½“æ–¹å·®ï¼ˆPopulation Varianceï¼‰

- **å®šä¹‰**ï¼šä»¥ \(n\) ä¸ºåˆ†æ¯çš„æ–¹å·®ï¼Œåˆ»ç”»ç»å¯¹è¯¯å·®çš„ç¦»æ•£ç¨‹åº¦
- **ç”¨é€”**ï¼šç”¨äº"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"åˆ†æï¼Œåæ˜ è¯¯å·®å¤§å°çš„ç¦»æ•£ç¨‹åº¦

**æ ‡å‡†æ€»ä½“æ–¹å·®å…¬å¼**ï¼ˆä½¿ç”¨å¸¦ç¬¦å·å€¼ï¼‰ï¼š
\[
\sigma^2 = \frac{1}{n} \sum_{i=1}^{n} (x_i - \mu)^2
\]
å…¶ä¸­ï¼š
\[
\mu = \frac{1}{n} \sum_{i=1}^{n} x_i
\]

**å®Œå…¨å±•å¼€å¼**ï¼š
\[
\sigma^2 = \frac{1}{n} \left[ (x_1 - \mu)^2 + (x_2 - \mu)^2 + \cdots + (x_n - \mu)^2 \right]
\]

**æœ¬é¡¹ç›®å®ç°çš„æ€»ä½“æ–¹å·®å…¬å¼**ï¼ˆä½¿ç”¨ç»å¯¹å€¼ï¼‰ï¼š
\[
\sigma^2 = \frac{1}{n} \sum_{i=1}^{n} (|x_i| - \mu_{\text{abs}})^2
\]
å…¶ä¸­ï¼š
\[
\mu_{\text{abs}} = \frac{1}{n} \sum_{i=1}^{n} |x_i|
\]

**å®Œå…¨å±•å¼€å¼**ï¼š
\[
\sigma^2 = \frac{1}{n} \left[ (|x_1| - \mu_{\text{abs}})^2 + (|x_2| - \mu_{\text{abs}})^2 + \cdots + (|x_n| - \mu_{\text{abs}})^2 \right]
\]
å…¶ä¸­ï¼š
\[
\mu_{\text{abs}} = \frac{1}{n} \left( |x_1| + |x_2| + \cdots + |x_n| \right)
\]

**é‡è¦è¯´æ˜**ï¼šæœ¬é¡¹ç›®**ä½¿ç”¨ç»å¯¹å€¼** \(|x_i|\) è®¡ç®—æ€»ä½“æ–¹å·®ï¼Œè€Œéæ ‡å‡†å…¬å¼ä¸­çš„å¸¦ç¬¦å·å€¼ \(x_i\)ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ç”¨äºåˆ†æ"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"ï¼ˆå…³æ³¨è¯¯å·®å¤§å°è€Œéæå‰/æ»åæ–¹å‘ï¼‰ã€‚

- **æ•°æ®æ¥æº**ï¼šå¯¹æ‰€æœ‰åŒ¹é…å¯¹çš„ç»å¯¹è¯¯å·® \(|x_i|\)ï¼ˆå³ `abs(keyon_offset)`ï¼‰è®¡ç®—
- **å•ä½**ï¼šå†…éƒ¨ (0.1ms)Â²ï¼›UI æ˜¾ç¤º msÂ²ï¼ˆÃ·100ï¼‰
- **ä»£ç å®ç°**ï¼š`spmid/note_matcher.py:get_variance()`
- **UIæ˜¾ç¤º**ï¼šæ•°æ®æ¦‚è§ˆé¡µé¢çš„"æ€»ä½“æ–¹å·®"
- **è¯´æ˜**ï¼šä¸è¡¨æ ¼ä¸­æ¯ä¸ªæŒ‰é”®çš„æ–¹å·®è®¡ç®—æ–¹å¼ä¿æŒä¸€è‡´ï¼ˆéƒ½ä½¿ç”¨ç»å¯¹å€¼ï¼‰ï¼Œç”¨äºåˆ†æè¯¯å·®å¤§å°çš„ç¦»æ•£ç¨‹åº¦

---

##### 5. æ€»ä½“æ ‡å‡†å·®ï¼ˆPopulation Standard Deviationï¼‰

- **å®šä¹‰**ï¼šæ€»ä½“æ–¹å·®çš„å¹³æ–¹æ ¹
- **ç”¨é€”**ï¼šç”¨äº"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"åˆ†æï¼Œåæ˜ è¯¯å·®å¤§å°çš„ç¦»æ•£ç¨‹åº¦

**æ ‡å‡†æ€»ä½“æ ‡å‡†å·®å…¬å¼**ï¼ˆä½¿ç”¨å¸¦ç¬¦å·å€¼ï¼‰ï¼š
\[
\sigma = \sqrt{\sigma^2} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (x_i - \mu)^2}
\]
å…¶ä¸­ï¼š
\[
\mu = \frac{1}{n} \sum_{i=1}^{n} x_i
\]

**å®Œå…¨å±•å¼€å¼**ï¼š
\[
\sigma = \sqrt{\frac{1}{n} \left[ (x_1 - \mu)^2 + (x_2 - \mu)^2 + \cdots + (x_n - \mu)^2 \right]}
\]
å…¶ä¸­ï¼š
\[
\mu = \frac{1}{n} \left( x_1 + x_2 + \cdots + x_n \right)
\]

**æœ¬é¡¹ç›®å®ç°çš„æ€»ä½“æ ‡å‡†å·®å…¬å¼**ï¼ˆä½¿ç”¨ç»å¯¹å€¼ï¼‰ï¼š
\[
\sigma = \sqrt{\sigma^2} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (|x_i| - \mu_{\text{abs}})^2}
\]
å…¶ä¸­ï¼š
\[
\mu_{\text{abs}} = \frac{1}{n} \sum_{i=1}^{n} |x_i|
\]

**å®Œå…¨å±•å¼€å¼**ï¼š
\[
\sigma = \sqrt{\frac{1}{n} \left[ (|x_1| - \mu_{\text{abs}})^2 + (|x_2| - \mu_{\text{abs}})^2 + \cdots + (|x_n| - \mu_{\text{abs}})^2 \right]}
\]
å…¶ä¸­ï¼š
\[
\mu_{\text{abs}} = \frac{1}{n} \left( |x_1| + |x_2| + \cdots + |x_n| \right)
\]

**é‡è¦è¯´æ˜**ï¼šæœ¬é¡¹ç›®**ä½¿ç”¨ç»å¯¹å€¼** \(|x_i|\) è®¡ç®—æ€»ä½“æ ‡å‡†å·®ï¼Œè€Œéæ ‡å‡†å…¬å¼ä¸­çš„å¸¦ç¬¦å·å€¼ \(x_i\)ã€‚ä¸æ€»ä½“æ–¹å·®çš„è®¡ç®—æ–¹å¼ä¿æŒä¸€è‡´ã€‚

- **æ•°æ®æ¥æº**ï¼šå¯¹æ‰€æœ‰åŒ¹é…å¯¹çš„ç»å¯¹è¯¯å·® \(|x_i|\)ï¼ˆå³ `abs(keyon_offset)`ï¼‰è®¡ç®—
- **å•ä½**ï¼šå†…éƒ¨ 0.1msï¼›UI æ˜¾ç¤º msï¼ˆÃ·10ï¼‰
- **ä»£ç å®ç°**ï¼š`spmid/note_matcher.py:get_standard_deviation()`
  - ç›´æ¥è°ƒç”¨ `get_variance()` ç„¶åå¼€å¹³æ–¹æ ¹
  - ç”±äº `get_variance()` ä½¿ç”¨ç»å¯¹å€¼è®¡ç®—ï¼Œæ­¤æ–¹æ³•ä¹Ÿä½¿ç”¨ç»å¯¹å€¼
- **UIæ˜¾ç¤º**ï¼šæ•°æ®æ¦‚è§ˆé¡µé¢çš„"æ€»ä½“æ ‡å‡†å·®"
- **è¯´æ˜**ï¼šä¸è¡¨æ ¼ä¸­æ¯ä¸ªæŒ‰é”®çš„æ ‡å‡†å·®è®¡ç®—æ–¹å¼ä¿æŒä¸€è‡´ï¼ˆéƒ½ä½¿ç”¨ç»å¯¹å€¼ï¼‰ï¼Œç”¨äºåˆ†æè¯¯å·®å¤§å°çš„ç¦»æ•£ç¨‹åº¦

---

#### ç»Ÿè®¡å£å¾„è¯´æ˜

**ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è¯¯å·®çš„æŒ‡æ ‡**ï¼ˆç”¨äº"æ—¶å»¶ä¸æŒ‰é”®çš„å…³ç³»"åˆ†æï¼‰ï¼š

ä»¥ä¸‹æŒ‡æ ‡ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è¯¯å·® \( y_i = |x_i| \) è®¡ç®—ï¼Œå…³æ³¨è¯¯å·®å¤§å°è€Œéæå‰/æ»åæ–¹å‘ï¼š

- **å¹³å‡ç»å¯¹è¯¯å·®ï¼ˆMAEï¼‰**ï¼š
  \[
  \mu_y = \frac{1}{n} \sum_{i=1}^{n} y_i
  \]
- **æ€»ä½“æ–¹å·®**ï¼š
  \[
  \sigma^2 = \frac{1}{n} \sum_{i=1}^{n} (y_i - \mu_y)^2
  \]
- **æ€»ä½“æ ‡å‡†å·®**ï¼š
  \[
  \sigma = \sqrt{\sigma^2} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \mu_y)^2}
  \]
- **è¡¨æ ¼ä¸­æ¯ä¸ªæŒ‰é”®çš„ç»Ÿè®¡é‡**ï¼šå‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ã€æ–¹å·®ã€æœ€å€¼ã€æå·®ï¼ˆå‡åŸºäº \( y_i \) è®¡ç®—ï¼‰
- **æŸ±çŠ¶å›¾ä¸­æ¯ä¸ªæŒ‰é”®çš„ç»Ÿè®¡é‡**ï¼šå‡å€¼ã€æ ‡å‡†å·®ã€æ–¹å·®ï¼ˆå‡åŸºäº \( y_i \) è®¡ç®—ï¼‰

**ä½¿ç”¨å¸¦ç¬¦å·å€¼çš„æŒ‡æ ‡**ï¼ˆç”¨äºç³»ç»Ÿæ€§åå·®åˆ†æï¼‰ï¼š

ä»¥ä¸‹æŒ‡æ ‡ä½¿ç”¨å¸¦ç¬¦å·å€¼ \( x_i \) è®¡ç®—ï¼Œåæ˜ æ•´ä½“æå‰/æ»åæ–¹å‘æ€§ï¼š

- **æ€»ä½“å‡å€¼ï¼ˆÎ¼ï¼‰**ï¼š
  \[
  \mu = \frac{1}{n} \sum_{i=1}^{n} x_i
  \]
- **å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰**ï¼š
  \[
  \mathrm{MSE} = \frac{1}{n} \sum_{i=1}^{n} x_i^2
  \]

**ç‰¹æ®Šè¯´æ˜**ï¼š

- **æ­£æ€æ‹Ÿåˆæ›²çº¿**ï¼šä½¿ç”¨å¸¦ç¬¦å·çš„åŸå§‹æ•°æ® \( x_i \) å’Œæ ·æœ¬æ ‡å‡†å·®ï¼ˆåˆ†æ¯ \( n-1 \)ï¼‰ï¼Œç”¨äºè¯„ä¼°å»¶æ—¶åˆ†å¸ƒæ˜¯å¦ç¬¦åˆæ­£æ€åˆ†å¸ƒ
- **`get_offset_statistics()` è¿”å›çš„æ ‡å‡†å·®**ï¼šä½¿ç”¨æ ·æœ¬æ ‡å‡†å·®ï¼ˆåˆ†æ¯ \( n-1 \)ï¼‰ï¼Œä¸æ•°æ®æ¦‚è§ˆé¡µé¢çš„æ€»ä½“æ ‡å‡†å·®ï¼ˆä½¿ç”¨æ€»ä½“å®šä¹‰ \( n \)ï¼‰ä¸åŒ

### 5.5 å»¶æ—¶åˆ†å¸ƒç›´æ–¹å›¾ä¸æ­£æ€æ‹Ÿåˆæ›²çº¿

**åŠŸèƒ½è¯´æ˜**ï¼š
å»¶æ—¶åˆ†å¸ƒç›´æ–¹å›¾ç”¨äºå¯è§†åŒ–å·²åŒ¹é…æŒ‰é”®å¯¹çš„å»¶æ—¶åˆ†å¸ƒæƒ…å†µï¼Œå¹¶å åŠ æ­£æ€æ‹Ÿåˆæ›²çº¿ï¼Œç”¨äºè¯„ä¼°å»¶æ—¶æ˜¯å¦ç¬¦åˆæ­£æ€åˆ†å¸ƒã€‚

**é‡è¦è¯´æ˜**ï¼šæœ¬å›¾è¡¨ä½¿ç”¨**å¸¦ç¬¦å·çš„å»¶æ—¶æ•°æ®**ï¼ˆ`keyon_offset`ï¼‰ï¼Œè€Œéç»å¯¹å€¼ã€‚è¿™æ ·å¯ä»¥åŒæ—¶å±•ç¤ºæå‰ï¼ˆè´Ÿå€¼ï¼‰å’Œå»¶è¿Ÿï¼ˆæ­£å€¼ï¼‰çš„åˆ†å¸ƒæƒ…å†µï¼Œç”¨äºè¯„ä¼°å»¶æ—¶åˆ†å¸ƒæ˜¯å¦ç¬¦åˆæ­£æ€åˆ†å¸ƒã€‚

#### å®ç°æ­¥éª¤

**1. æ•°æ®æå–ä¸è½¬æ¢**

```python
delays_ms = [item.get('keyon_offset', 0.0) / 10.0 for item in offset_data]
```

- ä» `offset_data` ä¸­æå– `keyon_offset`ï¼ˆ**å¸¦ç¬¦å·**ï¼Œå•ä½ 0.1msï¼‰
- è½¬æ¢ä¸º ms å•ä½ï¼ˆé™¤ä»¥ 10.0ï¼‰
- **ä¿ç•™ç¬¦å·**ï¼š
  - æ­£å€¼ï¼šå›æ”¾æ»åäºå½•åˆ¶ï¼ˆå»¶è¿Ÿï¼‰
  - è´Ÿå€¼ï¼šå›æ”¾æå‰äºå½•åˆ¶ï¼ˆæå‰ï¼‰
  - é›¶å€¼ï¼šæ— å»¶æ—¶

**2. ç»˜åˆ¶ç›´æ–¹å›¾**

```python
fig.add_trace(go.Histogram(
    x=delays_ms,
    histnorm='probability density',
    name='å»¶æ—¶åˆ†å¸ƒ',
    marker_color='rgba(33, 150, 243, 0.6)',
    opacity=0.7
))
```

- **`histnorm='probability density'`**ï¼šå½’ä¸€åŒ–ä¸ºæ¦‚ç‡å¯†åº¦ï¼Œä½¿å¾—ç›´æ–¹å›¾æ€»é¢ç§¯ = 1

- **å½’ä¸€åŒ–å…¬å¼**ï¼š
  
  $$
  f(x) = \frac{F_k}{n \cdot \Delta x}
  $$
  
  <img title="" src="file:///C:/Users/xuche/Pictures/Typedown/0d5ddf18-cc10-48b0-84a3-952cc05b43e6.png" alt="0d5ddf18-cc10-48b0-84a3-952cc05b43e6" data-align="center" style="zoom:50%;">

- Plotly è‡ªåŠ¨ç¡®å®šåŒºé—´æ•°ï¼ˆbinsï¼‰ã€ç»Ÿè®¡é¢‘æ•°ã€å½’ä¸€åŒ–å¹¶ç»˜åˆ¶

**3. è®¡ç®—ç»Ÿè®¡é‡**

```python
n = len(delays_ms)
mean_val = sum(delays_ms) / n  # æ ·æœ¬å‡å€¼ï¼šÎ¼ = (1/n) * Î£x_i
if n > 1:
    var = sum((x - mean_val) ** 2 for x in delays_ms) / (n - 1)  # æ ·æœ¬æ–¹å·®ï¼šsÂ² = (1/(n-1)) * Î£(x_i - Î¼)Â²
    std_val = var ** 0.5  # æ ·æœ¬æ ‡å‡†å·®ï¼šs = âˆšsÂ²
else:
    std_val = 0.0  # åªæœ‰ä¸€ä¸ªæ•°æ®ç‚¹ï¼Œæ— æ³•è®¡ç®—æ ‡å‡†å·®
```

**è¯¦ç»†è¯´æ˜**ï¼š

- **æ ·æœ¬å‡å€¼**ï¼š
  
  $$
  \bar{x} = \frac{
1}{n} \sum_{i=1
}^{n} x_iï¼ˆå¸¦ç¬¦å·å€¼çš„å‡å€¼ï¼‰
  $$
  
  - å¦‚æœ `mean_val > 0`ï¼šæ•´ä½“ä¸Šå›æ”¾æ»åäºå½•åˆ¶
  - å¦‚æœ `mean_val < 0`ï¼šæ•´ä½“ä¸Šå›æ”¾æå‰äºå½•åˆ¶
  - å¦‚æœ `mean_val â‰ˆ 0`ï¼šæ•´ä½“ä¸Šå»¶æ—¶æ¥è¿‘0

- **æ ·æœ¬æ–¹å·®**ï¼š
  
  $$
  s^
2 = \frac{1}{n-1} \sum_{i=1}^{n} (x_i - \bar{x})^2
  $$
  
  - ä½¿ç”¨ `n-1` ä½œä¸ºåˆ†æ¯ï¼ˆè´å¡å°”æ ¡æ­£ï¼‰ï¼Œå¾—åˆ°æ€»ä½“æ–¹å·®çš„æ— åä¼°è®¡

- **æ ·æœ¬æ ‡å‡†å·®**ï¼š
  
  $$
  (s = \sqrt{s^2})
  $$
  
  - è¡¡é‡æ•°æ®çš„ç¦»æ•£ç¨‹åº¦
  - å¦‚æœ `std_val = 0`ï¼Œè¯´æ˜æ‰€æœ‰æ•°æ®å€¼å®Œå…¨ç›¸åŒï¼Œæ— æ³•æ‹Ÿåˆæ­£æ€åˆ†å¸ƒ

**4. ç”Ÿæˆæ­£æ€æ‹Ÿåˆæ›²çº¿**

**å‰ç½®æ¡ä»¶**ï¼š

```python
if std_val > 0:  # åªæœ‰å½“æ ‡å‡†å·®å¤§äº0æ—¶æ‰ç»˜åˆ¶æ›²çº¿ï¼ˆéœ€è¦ç¦»æ•£æ€§ï¼‰
```

**4.1 ç¡®å®šæ›²çº¿ç»˜åˆ¶èŒƒå›´**

```python
min_x = min(delays_ms)  # æ•°æ®æœ€å°å€¼ï¼ˆå¯èƒ½ä¸ºè´Ÿï¼Œè¡¨ç¤ºæå‰ï¼‰
max_x = max(delays_ms)  # æ•°æ®æœ€å¤§å€¼ï¼ˆå¯èƒ½ä¸ºæ­£ï¼Œè¡¨ç¤ºå»¶è¿Ÿï¼‰

span = max(1e-6, 3 * std_val)  # 3ÏƒèŒƒå›´çš„ä¸€åŠå®½åº¦
x_start = min(mean_val - span, min_x)  # èµ·ç‚¹ï¼šç†è®ºä¸‹ç•Œä¸å®é™…æœ€å°å€¼çš„è¾ƒå°è€…
x_end = max(mean_val + span, max_x)    # ç»ˆç‚¹ï¼šç†è®ºä¸Šç•Œä¸å®é™…æœ€å¤§å€¼çš„è¾ƒå¤§è€…
```

**è¯¦ç»†è¯´æ˜**ï¼š

- **è·å–å®é™…æ•°æ®èŒƒå›´**ï¼š`min_x` å’Œ `max_x` æ˜¯å®é™…æ•°æ®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
- **è®¡ç®— 3Ïƒ èŒƒå›´**ï¼š
  - åœ¨æ­£æ€åˆ†å¸ƒä¸­ï¼Œçº¦ 99.7% çš„æ•°æ®è½åœ¨ `[Î¼ - 3Ïƒ, Î¼ + 3Ïƒ]` èŒƒå›´å†…
  - `span = 3 * std_val` è¡¨ç¤ºä»å‡å€¼åˆ°è¾¹ç•Œçš„ä¸€åŠå®½åº¦
  - `max(1e-6, ...)` é˜²æ­¢æ ‡å‡†å·®æå°å¯¼è‡´èŒƒå›´è¿‡å°æˆ–é™¤é›¶é”™è¯¯
- **ç¡®å®šæ›²çº¿èµ·ç‚¹å’Œç»ˆç‚¹**ï¼š
  - `x_start = min(mean_val - span, min_x)`ï¼šå–ç†è®ºä¸‹ç•Œï¼ˆ`mean_val - 3Ïƒ`ï¼‰ä¸å®é™…æœ€å°å€¼ï¼ˆ`min_x`ï¼‰çš„è¾ƒå°è€…
  - `x_end = max(mean_val + span, max_x)`ï¼šå–ç†è®ºä¸Šç•Œï¼ˆ`mean_val + 3Ïƒ`ï¼‰ä¸å®é™…æœ€å¤§å€¼ï¼ˆ`max_x`ï¼‰çš„è¾ƒå¤§è€…
  - **è®¾è®¡ç›®çš„**ï¼šå–æ•°æ®èŒƒå›´ä¸ 3Ïƒ èŒƒå›´çš„å¹¶é›†ï¼Œæ—¢è¦†ç›–å®é™…æ•°æ®ï¼Œåˆå±•ç¤ºç†è®ºåˆ†å¸ƒç‰¹å¾

**ä¸ºä»€ä¹ˆæœ‰äº›æ›²çº¿æœ‰è´Ÿæ•°åŒºé—´ï¼Œæœ‰äº›æ²¡æœ‰ï¼Ÿ**

- **æœ‰è´Ÿæ•°åŒºé—´çš„æƒ…å†µ**ï¼š
  1. æ•°æ®ä¸­åŒ…å«è´Ÿå€¼ï¼ˆæå‰çš„æŒ‰é”®ï¼‰ï¼š`min_x < 0`ï¼Œæ›²çº¿è‡³å°‘å»¶ä¼¸åˆ° `min_x`
  2. æ•°æ®ä¸­æ²¡æœ‰è´Ÿå€¼ï¼Œä½†å‡å€¼è¾ƒå°ä¸”æ ‡å‡†å·®è¾ƒå¤§ï¼š`mean_val - 3*std_val < 0`ï¼Œæ›²çº¿ä¼šå»¶ä¼¸åˆ°è´Ÿæ•°åŒºé—´ï¼ˆå±•ç¤ºç†è®ºåˆ†å¸ƒï¼‰
- **æ²¡æœ‰è´Ÿæ•°åŒºé—´çš„æƒ…å†µ**ï¼š
  - æ•°æ®ä¸­æ²¡æœ‰è´Ÿå€¼ï¼Œä¸” `mean_val - 3*std_val >= 0`ï¼šæ›²çº¿èµ·ç‚¹åœ¨ 0 æˆ–æ­£æ•°åŒºé—´

**4.2 ç”Ÿæˆå‡åŒ€åˆ†å¸ƒçš„ x åæ ‡ç‚¹**

```python
num_pts = 200  # å›ºå®š200ä¸ªç‚¹ï¼Œè¶³å¤Ÿå¹³æ»‘ä¸”è®¡ç®—é«˜æ•ˆ
step = (x_end - x_start) / (num_pts - 1) if num_pts > 1 else 1.0  # ç‚¹ä¹‹é—´çš„é—´è·
xs = [x_start + i * step for i in range(num_pts)]  # ç”Ÿæˆå‡åŒ€åˆ†å¸ƒçš„xåæ ‡åºåˆ—
```

**è¯¦ç»†è¯´æ˜**ï¼š

- **é‡‡æ ·ç‚¹æ•°**ï¼šå›ºå®š 200 ä¸ªç‚¹
  - è¶³å¤Ÿå¤šï¼šä¿è¯æ›²çº¿å¹³æ»‘ï¼Œè§†è§‰ä¸Šè¿ç»­
  - ä¸ä¼šå¤ªå¤šï¼šä¸ä¼šæµªè´¹è®¡ç®—èµ„æºï¼Œæ€§èƒ½å¹³è¡¡
  - ç»éªŒå€¼ï¼šå¯¹äºå¤§å¤šæ•°æ˜¾ç¤ºåˆ†è¾¨ç‡ï¼Œ200 ä¸ªç‚¹å·²ç»è¶³å¤Ÿå¹³æ»‘
- **è®¡ç®—æ­¥é•¿**ï¼š
  - `step = (x_end - x_start) / (num_pts - 1)`
  - æ€»èŒƒå›´ï¼š`x_end - x_start`
  - åŒºé—´æ•°ï¼š`num_pts - 1`ï¼ˆ200 ä¸ªç‚¹ä¹‹é—´æœ‰ 199 ä¸ªåŒºé—´ï¼‰
- **ç”Ÿæˆ x åæ ‡åºåˆ—**ï¼š
  - `xs = [x_start, x_start + step, x_start + 2 * step, ..., x_end]`
  - è¿™äº›ç‚¹åœ¨ x è½´ä¸Šå‡åŒ€åˆ†å¸ƒï¼ˆç­‰é—´è·ï¼‰
  - ä¸æ˜¯æ•°æ®æœ¬èº«çš„ç‚¹ï¼Œè€Œæ˜¯ç†è®ºæ›²çº¿çš„é‡‡æ ·ç‚¹

**4.3 è®¡ç®—æ¯ä¸ª x ç‚¹çš„æ¦‚ç‡å¯†åº¦å€¼ï¼ˆæ­£æ€åˆ†å¸ƒ PDFï¼‰**

```python
ys = [(1.0 / (std_val * (2 * math.pi) ** 0.5)) * 
      math.exp(-0.5 * ((x - mean_val) / std_val) ** 2) 
      for x in xs]
```

**æ­£æ€åˆ†å¸ƒæ¦‚ç‡å¯†åº¦å‡½æ•°å…¬å¼**ï¼š

$$
f(x) = \frac{1}{\sigma\sqrt{2\pi}} \exp\left(-\frac{1}{2}\left(\frac{x-\mu}{\sigma}\right)^2\right)
$$

**å…¬å¼è¯¦ç»†åˆ†è§£**ï¼š

1. $$
   å½’ä¸€åŒ–å¸¸æ•°ï¼š( \frac{1}{\sigma\sqrt{2\pi}})
   $$
   
   - **ä½œç”¨**ï¼šç¡®ä¿æ•´ä¸ªæ›²çº¿ä¸‹çš„é¢ç§¯ä¸º 1ï¼ˆæ¦‚ç‡çš„åŸºæœ¬æ€§è´¨ï¼‰
   - **å€¼**ï¼šä¸æ ‡å‡†å·®æˆåæ¯”ï¼Œæ ‡å‡†å·®è¶Šå¤§ï¼Œæ›²çº¿è¶Š"æ‰å¹³"
   - **ä»£ç **ï¼š`1.0 / (std_val * (2 * math.pi) ** 0.5)`

2. 
   
   $$
   æŒ‡æ•°é¡¹ï¼š( \exp\left(-\frac{1}{2}\left(\frac{x-\mu}{\sigma}\right)^2\right) )
   $$
   
   - $$
     æ ‡å‡†åŒ–åå·®ï¼ˆz-scoreï¼‰ï¼š( z = \frac{x-\mu}{\sigma})
     $$
     
     - è¡¨ç¤ºè¿™ä¸ªç‚¹è·ç¦»å‡å€¼æœ‰å¤šå°‘ä¸ªæ ‡å‡†å·®
     - `z = 0`ï¼šç‚¹åœ¨å‡å€¼å¤„
     - `z > 0`ï¼šç‚¹åœ¨å‡å€¼å³ä¾§
     - `z < 0`ï¼šç‚¹åœ¨å‡å€¼å·¦ä¾§
   
   - 
     
     $$
     å¹³æ–¹é¡¹ï¼š( z^2 = \left(\frac{x-\mu}{\sigma}\right)^2)
     $$
     
     - ç¡®ä¿æ­£è´Ÿåå·®åŒç­‰å¯¹å¾…ï¼ˆä¾‹å¦‚ï¼Œ`z = 2` å’Œ `z = -2` çš„å¹³æ–¹éƒ½æ˜¯ 4ï¼‰
   
   - **æŒ‡æ•°è¡°å‡**ï¼š\( \exp(-0.5 \times z^2) \)
     
     $$
     æŒ‡æ•°è¡°å‡ï¼š( \exp(-0.5 \times z^2))
     $$
     
     - å½“ `z = 0`ï¼ˆåœ¨å‡å€¼å¤„ï¼‰ï¼š`exp(0) = 1.0`ï¼Œè¿™æ˜¯æœ€å¤§å€¼
     - å½“ `z` å˜å¤§æ—¶ï¼š`exp(-0.5 Ã— zÂ²)` å¿«é€Ÿè¡°å‡ï¼Œæ¥è¿‘ 0
   
   - **ä»£ç **ï¼š`math.exp(-0.5 * ((x - mean_val) / std_val) ** 2)`

**è®¡ç®—ç¤ºä¾‹**ï¼ˆå‡è®¾ `mean_val = 1.0 ms`ï¼Œ`std_val = 1.5 ms`ï¼‰ï¼š

| x (ms)  | z = (x-Î¼)/Ïƒ | zÂ²      | exp(-0.5Ã—zÂ²) | å½’ä¸€åŒ–å¸¸æ•°     | f(x) = å½’ä¸€åŒ–Ã—exp     |
| ------- | ----------- | ------- | ------------ | --------- | ------------------ |
| -2.0    | -2.0        | 4.0     | 0.1353       | 0.266     | 0.036              |
| -0.5    | -1.0        | 1.0     | 0.6065       | 0.266     | 0.161              |
| **1.0** | **0.0**     | **0.0** | **1.0000**   | **0.266** | **0.266** â­ **å³°å€¼** |
| 2.5     | 1.0         | 1.0     | 0.6065       | 0.266     | 0.161              |
| 4.0     | 2.0         | 4.0     | 0.1353       | 0.266     | 0.036              |

**è§‚å¯Ÿ**ï¼š

- âœ… åœ¨å‡å€¼å¤„ï¼ˆx = 1.0ï¼‰ï¼Œæ¦‚ç‡å¯†åº¦æœ€å¤§ï¼ˆ0.266ï¼‰
- âœ… è·ç¦»å‡å€¼è¶Šè¿œï¼Œæ¦‚ç‡å¯†åº¦è¶Šå°ï¼ˆå¯¹ç§°è¡°å‡ï¼‰
- âœ… æ­£è´Ÿåå·®åŒç­‰å¯¹å¾…ï¼ˆä¾‹å¦‚ï¼Œx = -0.5 å’Œ x = 2.5 çš„æ¦‚ç‡å¯†åº¦ç›¸åŒï¼‰

**4.4 ç»˜åˆ¶æ­£æ€æ‹Ÿåˆæ›²çº¿**

```python
fig.add_trace(go.Scatter(
    x=xs,  # 200ä¸ªxåæ ‡ï¼ˆå»¶æ—¶å€¼ï¼Œå•ä½ï¼šmsï¼‰
    y=ys,  # 200ä¸ªå¯¹åº”çš„æ¦‚ç‡å¯†åº¦å€¼
    mode='lines',  # ç”¨çº¿æ®µè¿æ¥ç‚¹ï¼Œå½¢æˆè¿ç»­æ›²çº¿
    name=f"æ­£æ€æ‹Ÿåˆ (Î¼={mean_val:.2f}ms, Ïƒ={std_val:.2f}ms)",  # å›¾ä¾‹æ˜¾ç¤ºå‡å€¼å’Œæ ‡å‡†å·®
    line=dict(color='#e53935', width=2)  # çº¢è‰²æ›²çº¿ï¼Œçº¿å®½2åƒç´ 
))
```

**è¯¦ç»†è¯´æ˜**ï¼š

- **å‚æ•°è¯´æ˜**ï¼š
  - `x=xs`ï¼š200 ä¸ª x åæ ‡ï¼ˆå»¶æ—¶å€¼ï¼Œå•ä½ï¼šmsï¼‰
  - `y=ys`ï¼š200 ä¸ªå¯¹åº”çš„æ¦‚ç‡å¯†åº¦å€¼
  - `mode='lines'`ï¼šç”¨çº¿æ®µè¿æ¥ç‚¹ï¼Œå½¢æˆè¿ç»­å¹³æ»‘çš„æ›²çº¿
  - `name`ï¼šå›¾ä¾‹æ˜¾ç¤ºï¼ŒåŒ…å«å‡å€¼å’Œæ ‡å‡†å·®ï¼ˆä¾‹å¦‚ï¼š"æ­£æ€æ‹Ÿåˆ (Î¼=1.00ms, Ïƒ=1.50ms)"ï¼‰
  - `line=dict(color='#e53935', width=2)`ï¼šçº¢è‰²æ›²çº¿ï¼ˆ`#e53935`ï¼‰ï¼Œçº¿å®½ 2 åƒç´ 
- **ç»˜åˆ¶åŸç†**ï¼š
  - ä½¿ç”¨ Scatter å›¾ç”¨çº¿æ®µè¿æ¥æ‰€æœ‰ `(x, y)` ç‚¹
  - ç”±äºç‚¹è¶³å¤Ÿå¯†é›†ï¼ˆ200 ä¸ªï¼‰ï¼Œè§†è§‰ä¸Šå½¢æˆè¿ç»­å¹³æ»‘çš„æ›²çº¿
  - æ›²çº¿å±•ç¤º"å¦‚æœæ•°æ®å®Œå…¨ç¬¦åˆæ­£æ€åˆ†å¸ƒï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„åˆ†å¸ƒ"

---

#### å…³é”®æŠ€æœ¯ç»†èŠ‚æ€»ç»“

**1. ä¸ºä»€ä¹ˆä½¿ç”¨æ ·æœ¬æ ‡å‡†å·®ï¼ˆn-1ï¼‰è€Œä¸æ˜¯æ€»ä½“æ ‡å‡†å·®ï¼ˆnï¼‰ï¼Ÿ**

- **è´å¡å°”æ ¡æ­£**ï¼šæ ·æœ¬æ–¹å·®æ˜¯æ€»ä½“æ–¹å·®çš„æ— åä¼°è®¡
- åœ¨ç»Ÿè®¡æ¨æ–­ä¸­ï¼Œæ— åä¼°è®¡æ›´ç¨³å¥ï¼Œæ›´é€‚åˆæ¨¡å‹æ‹Ÿåˆ
- **æ•°å­¦åŸç†**ï¼š
  - å¦‚æœä½¿ç”¨ nï¼š\( E[s^2] = \frac{n-1}{n} \sigma^2 \)ï¼ˆæœ‰åä¼°è®¡ï¼‰
  - å¦‚æœä½¿ç”¨ n-1ï¼š\( E[s^2] = \sigma^2 \)ï¼ˆæ— åä¼°è®¡ï¼‰

**2. ä¸ºä»€ä¹ˆä½¿ç”¨å¸¦ç¬¦å·æ•°æ®è€Œä¸æ˜¯ç»å¯¹å€¼ï¼Ÿ**

- **è¯„ä¼°å»¶æ—¶åˆ†å¸ƒæ˜¯å¦ç¬¦åˆæ­£æ€åˆ†å¸ƒ**ï¼Œè€Œéä»…åˆ†æè¯¯å·®å¤§å°
- å¯ä»¥åŒæ—¶å±•ç¤ºæå‰ï¼ˆè´Ÿå€¼ï¼‰å’Œå»¶è¿Ÿï¼ˆæ­£å€¼ï¼‰çš„åˆ†å¸ƒç‰¹å¾
- ç”¨äºè¯„ä¼°æ•´ä½“åˆ†å¸ƒç‰¹å¾ï¼Œè€Œéä»…è¯¯å·®å¤§å°

**3. ä¸ºä»€ä¹ˆå–æ•°æ®èŒƒå›´ä¸ 3Ïƒ èŒƒå›´çš„å¹¶é›†ï¼Ÿ**

- **è¦†ç›–å®é™…æ•°æ®**ï¼šç¡®ä¿æ›²çº¿è¦†ç›–æ‰€æœ‰å®é™…æ•°æ®ç‚¹
- **å±•ç¤ºç†è®ºç‰¹å¾**ï¼šå»¶ä¼¸åˆ° 3Ïƒ èŒƒå›´ï¼Œå±•ç¤ºç†è®ºä¸Šçš„åˆ†å¸ƒç‰¹å¾
- **è§†è§‰å®Œæ•´æ€§**ï¼šæä¾›å®Œæ•´çš„åˆ†å¸ƒè§†å›¾ï¼Œä¾¿äºè§‚å¯Ÿå°¾éƒ¨ç‰¹å¾
- **è®¾è®¡ç›®çš„**ï¼šæ—¢è¦†ç›–å®é™…æ•°æ®ï¼Œåˆå±•ç¤ºç†è®ºåˆ†å¸ƒç‰¹å¾

**4. ä¸ºä»€ä¹ˆä½¿ç”¨ 200 ä¸ªé‡‡æ ·ç‚¹ï¼Ÿ**

- **è¶³å¤Ÿå¤š**ï¼šä¿è¯æ›²çº¿å¹³æ»‘ï¼Œè§†è§‰ä¸Šè¿ç»­
- **ä¸ä¼šå¤ªå¤š**ï¼šä¸ä¼šæµªè´¹è®¡ç®—èµ„æºï¼Œæ€§èƒ½å¹³è¡¡
- **ç»éªŒå€¼**ï¼šå¯¹äºå¤§å¤šæ•°æ˜¾ç¤ºåˆ†è¾¨ç‡ï¼Œ200 ä¸ªç‚¹å·²ç»è¶³å¤Ÿå¹³æ»‘

**5. ä¸ºä»€ä¹ˆä½¿ç”¨æ¦‚ç‡å¯†åº¦å½’ä¸€åŒ–ï¼Ÿ**

- ç›´æ–¹å›¾æ€»é¢ç§¯ = 1ï¼Œä¸æ­£æ€åˆ†å¸ƒçš„é¢ç§¯ä¸€è‡´
- ç›´æ–¹å›¾å’Œæ‹Ÿåˆæ›²çº¿åœ¨åŒä¸€å°ºåº¦ä¸Šï¼Œä¾¿äºå¯¹æ¯”è¯„ä¼°
- **å½’ä¸€åŒ–å…¬å¼**ï¼š\( f(x) = \frac{F_k}{n \times \Delta x} \)ï¼Œå…¶ä¸­ \( F_k \) æ˜¯åŒºé—´ k çš„é¢‘æ•°

---

#### å…³é”®æ•°å­—æ€»ç»“

- **200 ä¸ªé‡‡æ ·ç‚¹**ï¼šå¹³è¡¡å¹³æ»‘åº¦ä¸è®¡ç®—æ•ˆç‡
- **3Ïƒ èŒƒå›´**ï¼šè¦†ç›–çº¦ 99.7% çš„æ•°æ®
- **æ ·æœ¬æ ‡å‡†å·®ï¼ˆn-1ï¼‰**ï¼šè´å¡å°”æ ¡æ­£ï¼Œæ— åä¼°è®¡
- **æ¦‚ç‡å¯†åº¦å½’ä¸€åŒ–**ï¼šæ€»é¢ç§¯ = 1ï¼Œä¾¿äºå¯¹æ¯”

---

#### å®Œæ•´æµç¨‹æ€»ç»“

```
1. æ•°æ®å‡†å¤‡ï¼šæå–å¸¦ç¬¦å·çš„keyon_offsetï¼Œè½¬æ¢ä¸ºmså•ä½
   â†“
2. ç»˜åˆ¶ç›´æ–¹å›¾ï¼šæ¦‚ç‡å¯†åº¦å½’ä¸€åŒ–ï¼Œæ€»é¢ç§¯=1
   â†“
3. è®¡ç®—ç»Ÿè®¡é‡ï¼šæ ·æœ¬å‡å€¼Î¼å’Œæ ·æœ¬æ ‡å‡†å·®Ïƒï¼ˆn-1åˆ†æ¯ï¼‰
   â†“
4. ç¡®å®šç»˜åˆ¶èŒƒå›´ï¼šæ•°æ®èŒƒå›´ âˆª 3ÏƒèŒƒå›´
   â†“
5. ç”Ÿæˆé‡‡æ ·ç‚¹ï¼šåœ¨èŒƒå›´å†…å‡åŒ€ç”Ÿæˆ200ä¸ªxåæ ‡ç‚¹
   â†“
6. è®¡ç®—æ¦‚ç‡å¯†åº¦ï¼šå¯¹æ¯ä¸ªxç‚¹ï¼Œä½¿ç”¨æ­£æ€åˆ†å¸ƒå…¬å¼è®¡ç®—yå€¼
   â†“
7. ç»˜åˆ¶æ›²çº¿ï¼šç”¨çº¿æ®µè¿æ¥æ‰€æœ‰(x, y)ç‚¹ï¼Œå½¢æˆè¿ç»­å¹³æ»‘çš„çº¢è‰²æ›²çº¿
```

**ä»£ç å®ç°ä½ç½®**ï¼š`backend/piano_analysis_backend.py:generate_delay_histogram_plot()`

## 6. è¡¨æ ¼æ•°æ®ç”Ÿæˆé˜¶æ®µ

### 6.1 é—®é¢˜åˆ—è¡¨ç”Ÿæˆ

**æ ¸å¿ƒå‡½æ•°**ï¼š`backend/table_data_generator.py:_build_error_table_rows()`

```python
def _build_error_table_rows(self, target_error_type: str) -> List[Dict[str, Any]]:
    """æ„å»ºé”™è¯¯è¡¨æ ¼è¡Œæ•°æ®"""

    table_data = []

    # é€‰æ‹©é”™è¯¯åˆ—è¡¨
    error_list = self.drop_hammers if target_error_type == 'record' else self.multi_hammers

    # è·å–åŒ¹é…å¤±è´¥åŸå› 
    failure_reasons = {}
    if hasattr(self.analyzer, 'note_matcher'):
        failure_reasons = getattr(self.analyzer.note_matcher, 'failure_reasons', {})

    for error_note in error_list:
        if len(error_note.infos) > 0:
            info = error_note.infos[0]

            # è·å–åˆ†æåŸå› 
            analysis_reason = 'ä¸¢é”¤ï¼ˆå½•åˆ¶æœ‰ï¼Œæ’­æ”¾æ— ï¼‰' if target_error_type == 'record' else 'å¤šé”¤ï¼ˆæ’­æ”¾æœ‰ï¼Œå½•åˆ¶æ— ï¼‰'
            if (target_error_type, info.index) in failure_reasons:
                analysis_reason = failure_reasons[(target_error_type, info.index)]

            table_data.append({
                'global_index': error_note.global_index,
                'problem_type': error_note.error_type,
                'data_type': 'record' if target_error_type == 'record' else 'play',
                'keyId': info.keyId,
                'keyOn': f"{info.keyOn/10:.2f}ms",  # è½¬æ¢ä¸ºmsæ˜¾ç¤º
                'keyOff': f"{info.keyOff/10:.2f}ms",  # è½¬æ¢ä¸ºmsæ˜¾ç¤º
                'index': info.index,
                'analysis_reason': analysis_reason  # æ–°å¢ï¼šæœªåŒ¹é…åŸå› 
            })

    return table_data
```

### 6.2 ç»Ÿè®¡æ¦‚è§ˆç”Ÿæˆ

**æ ¸å¿ƒå‡½æ•°**ï¼š`backend/table_data_generator.py:get_summary_info()`

```python
def get_summary_info(self) -> Dict[str, Any]:
    """è·å–ç»Ÿè®¡æ¦‚è§ˆä¿¡æ¯"""

    # åŸºç¡€ç»Ÿè®¡
    total_notes = len(self.initial_valid_record_data) + len(self.initial_valid_replay_data)
    valid_notes = len(self.valid_record_data) + len(self.valid_replay_data)

    # é”™è¯¯ç»Ÿè®¡
    drop_count = len(self.drop_hammers)
    multi_count = len(self.multi_hammers)
    silent_count = len(self.silent_hammers)

    # åŒ¹é…ç»Ÿè®¡
    matched_pairs = len(self.matched_pairs)

    # è®¡ç®—å‡†ç¡®ç‡
    accuracy = (matched_pairs / total_notes * 100) if total_notes > 0 else 0.0

    return {
        'total_notes': total_notes,
        'valid_notes': valid_notes,
        'drop_hammers': drop_count,
        'multi_hammers': multi_count,
        'silent_hammers': silent_count,
        'matching_analysis': {
            'matched_pairs': matched_pairs,
            'accuracy': accuracy
        }
    }
```

## 7. UIå±•ç¤ºé˜¶æ®µ

### 7.1 ç€‘å¸ƒå›¾ç”Ÿæˆ

**è°ƒç”¨é“¾**ï¼š

```
UI â†’ backend/plot_generator.py:generate_waterfall_plot() 
â†’ spmid/spmid_plot.py:plot_bar_plotly()
```

**æ ¸å¿ƒå®ç°**ï¼š`spmid/spmid_plot.py:plot_bar_plotly()`

```python
def plot_bar_plotly(record, play, time_range=None):
    """ä½¿ç”¨Plotlyç»˜åˆ¶ç€‘å¸ƒå›¾"""

    # 1. æå–æ¡å½¢æ®µæ•°æ®
    record_segments = get_bar_segments2(record)
    play_segments = get_bar_segments2(play)

    # 2. æ•°æ®å½’ä¸€åŒ–
    all_velocities = [seg[3] for seg in record_segments + play_segments]
    max_velocity = max(all_velocities) if all_velocities else 1

    # 3. åˆ›å»ºå›¾å½¢
    fig = go.Figure()

    # 4. ç»˜åˆ¶å½•åˆ¶æ•°æ®
    for t_hammer, key_off, key_id, v_hammer, index in record_segments:
        color_intensity = v_hammer / max_velocity
        fig.add_trace(go.Scatter(
            x=[t_hammer/10, key_off/10],  # è½¬æ¢ä¸ºms
            y=[key_id, key_id],
            mode='lines',
            line=dict(color=f'rgba(255, 0, 0, {color_intensity})', width=3),
            name=f'Record {key_id}',
            showlegend=False
        ))

    # 5. ç»˜åˆ¶æ’­æ”¾æ•°æ®
    for t_hammer, key_off, key_id, v_hammer, index in play_segments:
        color_intensity = v_hammer / max_velocity
        fig.add_trace(go.Scatter(
            x=[t_hammer/10, key_off/10],  # è½¬æ¢ä¸ºms
            y=[key_id, key_id],
            mode='lines',
            line=dict(color=f'rgba(0, 0, 255, {color_intensity})', width=3),
            name=f'Play {key_id}',
            showlegend=False
        ))

    # 6. è®¾ç½®å¸ƒå±€
    fig.update_layout(
        title="SPMID Waterfall Plot",
        xaxis_title="Time (ms)",
        yaxis_title="Key ID",
        height=600
    )

    return fig
```

### 7.2 ç»Ÿè®¡å¡ç‰‡å±•ç¤º

**å®ç°ä½ç½®**ï¼š`ui/layout_components.py:create_report_layout()`

```python
# ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
dbc.Row([
    dbc.Col([
        html.H3(f"{summary.get('total_notes', 0)}", className="text-primary mb-1"),
        html.P("æ€»éŸ³ç¬¦æ•°", className="text-muted mb-0")
    ], width=3),
    dbc.Col([
        html.H3(f"{summary.get('drop_hammers', 0)}", className="text-danger mb-1"),
        html.P("ä¸¢é”¤", className="text-muted mb-0")
    ], width=3),
    dbc.Col([
        html.H3(f"{summary.get('multi_hammers', 0)}", className="text-warning mb-1"),
        html.P("å¤šé”¤", className="text-muted mb-0")
    ], width=3),
    dbc.Col([
        html.H3(f"{average_delay_ms:.1f}ms", className="text-info mb-1"),
        html.P("å¹³å‡æ—¶å»¶", className="text-muted mb-0")
    ], width=3)
])

# æ–°å¢ï¼šå·²é…å¯¹éŸ³ç¬¦å¯¹æ•°
dbc.Row([
    dbc.Col([
        html.H3(f"{summary.get('matching_analysis', {}).get('matched_pairs', 0)}", className="text-secondary mb-1"),
        html.P("å·²é…å¯¹éŸ³ç¬¦å¯¹æ•°", className="text-muted mb-0")
    ], width=12)
])
```

### 7.3 é—®é¢˜åˆ—è¡¨è¡¨æ ¼

**ä¸¢é”¤/å¤šé”¤è¡¨æ ¼é…ç½®**ï¼š

```python
# ä¸¢é”¤é—®é¢˜åˆ—è¡¨
dash_table.DataTable(
    id='drop-hammers-table',
    columns=[
        {"name": "å…¨å±€ç´¢å¼•", "id": "global_index"},
        {"name": "é—®é¢˜ç±»å‹", "id": "problem_type"},
        {"name": "æ•°æ®ç±»å‹", "id": "data_type"},
        {"name": "é”®ID", "id": "keyId"},
        {"name": "æŒ‰é”®å¼€å§‹", "id": "keyOn"},
        {"name": "æŒ‰é”®ç»“æŸ", "id": "keyOff"},
        {"name": "ç´¢å¼•", "id": "index"},
        {"name": "æœªåŒ¹é…åŸå› ", "id": "analysis_reason"}  # æ–°å¢åˆ—
    ],
    data=backend.get_drop_hammers_data()
)

# å¤šé”¤é—®é¢˜åˆ—è¡¨ï¼ˆç±»ä¼¼é…ç½®ï¼‰
```

## 8. å·¥å…·è„šæœ¬

### 8.1 éŸ³ç¬¦æ›²çº¿å¯è§†åŒ–

**è„šæœ¬**ï¼š`tools/plot_note_curves.py`

```bash
# æŒ‰ç´¢å¼•é€‰æ‹©éŸ³ç¬¦
python tools/plot_note_curves.py --file your_file.spmid --track 0 --index 0

# æŒ‰æŒ‰é”®IDé€‰æ‹©éŸ³ç¬¦
python tools/plot_note_curves.py --file your_file.spmid --track 0 --key-id 60

# ä¿å­˜å›¾ç‰‡
python tools/plot_note_curves.py --file your_file.spmid --index 0 --save out.png
```

**åŠŸèƒ½**ï¼š

- ç»˜åˆ¶å•ä¸ªéŸ³ç¬¦çš„after_touchï¼ˆæ—¶é—´-æŒ‰é”®æ·±åº¦ï¼‰æ›²çº¿
- ç»˜åˆ¶hammersï¼ˆæ—¶é—´-é”¤é€Ÿï¼‰æ›²çº¿
- æ—¶é—´è½´è‡ªåŠ¨è½¬æ¢ä¸ºmsæ˜¾ç¤º

### 8.2 æ•°æ®æå–è„šæœ¬

**åŸå§‹æ•°æ®æå–**ï¼š`tools/extract_spmid_data_to_log.py`

- æå–æ¯ä¸ªéŸ³ç¬¦çš„å®Œæ•´after_touchå’Œhammersæ•°æ®
- è¾“å‡ºåˆ°ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…ä¸ç³»ç»Ÿæ—¥å¿—æ··åˆ

**è¿‡æ»¤æ•°æ®æå–**ï¼š`tools/extract_filtered_notes_to_log.py`

- å±•ç¤ºè¿‡æ»¤å‰åçš„æ•°æ®å¯¹æ¯”
- ç»Ÿè®¡å„ç§æ— æ•ˆåŸå› çš„æ•°é‡
- æä¾›æ— æ•ˆéŸ³ç¬¦çš„è¯¦ç»†ä¿¡æ¯

## 9. å…³é”®ç®—æ³•ç‰¹ç‚¹

### 9.1 åŠ¨æ€é˜ˆå€¼åŒ¹é…

**ä¼˜åŠ¿**ï¼š

- æ ¹æ®éŸ³ç¬¦æŒç»­æ—¶é—´è‡ªé€‚åº”è°ƒæ•´å®¹é”™èŒƒå›´
- çŸ­éŸ³ç¬¦ä½¿ç”¨è¾ƒå°é˜ˆå€¼ï¼ˆ30msï¼‰ï¼Œé•¿éŸ³ç¬¦ä½¿ç”¨è¾ƒå¤§é˜ˆå€¼ï¼ˆ50msï¼‰
- åªä½¿ç”¨keyon_offsetè¿›è¡ŒåŒ¹é…ï¼Œç®€åŒ–è®¡ç®—é€»è¾‘

**å…¬å¼**ï¼š

```
max_allowed_error = 500 * clamp(0.6, duration/500, 1.0) * 0.1ms  # 30-50msèŒƒå›´
total_error = |keyon_offset|  # åªä½¿ç”¨keyon_offsetçš„ç»å¯¹å€¼
```

### 9.2 ä¸€å¯¹ä¸€åŒ¹é…çº¦æŸ

**å®ç°**ï¼š

- ä½¿ç”¨`used_replay_indices`é›†åˆé˜²æ­¢é‡å¤åŒ¹é…
- ç¡®ä¿æ¯ä¸ªæ’­æ”¾éŸ³ç¬¦æœ€å¤šåŒ¹é…ä¸€æ¬¡
- è´ªå¿ƒé€‰æ‹©ï¼šä¼˜å…ˆé€‰æ‹©è¯¯å·®æœ€å°çš„å€™é€‰

### 9.3 å•ä½ä¸€è‡´æ€§ä¿è¯

**ç­–ç•¥**ï¼š

- å†…éƒ¨è®¡ç®—å…¨ç¨‹ä½¿ç”¨0.1mså•ä½
- ä»…åœ¨UIå±•ç¤ºå’Œæ—¥å¿—è¾“å‡ºæ—¶è½¬æ¢ä¸ºms
- é¿å…å¤šæ¬¡å•ä½è½¬æ¢å¯¼è‡´çš„æ•°æ®ç²¾åº¦æŸå¤±

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 åŒ¹é…ç®—æ³•ä¼˜åŒ–

- æŒ‰é”®IDé¢„ç­›é€‰ï¼Œå‡å°‘å€™é€‰æ•°é‡
- æ—©æœŸè¿”å›æœºåˆ¶ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
- åŠ¨æ€é˜ˆå€¼é¿å…è¿‡åº¦ä¸¥æ ¼çš„åŒ¹é…æ¡ä»¶

### 10.2 å†…å­˜ä¼˜åŒ–

- åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼Œå‡å°‘å†…å­˜å ç”¨
- åªä¿ç•™å¿…è¦çš„åŒ¹é…æ•°æ®

### 10.3 æ—¥å¿—ä¼˜åŒ–

- é™åˆ¶è¯¦ç»†æ—¥å¿—çš„è¾“å‡ºæ•°é‡ï¼ˆå¦‚å€™é€‰è¯¦æƒ…æœ€å¤šæ˜¾ç¤º3ä¸ªï¼‰
- åˆ†çº§æ—¥å¿—è®°å½•ï¼ˆINFO/DEBUGï¼‰
- å…³é”®ä¿¡æ¯åŒæ—¶æ˜¾ç¤º0.1mså’Œmså•ä½

## 11. é”™è¯¯å¤„ç†

### 11.1 æ•°æ®éªŒè¯

- è½¨é“æ•°é‡éªŒè¯ï¼šè‡³å°‘éœ€è¦2ä¸ªè½¨é“
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼šç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨
- åŒ¹é…ç»“æœéªŒè¯ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 11.2 å¼‚å¸¸å¤„ç†

- ç›´æ¥å¼‚å¸¸æŠ›å‡ºï¼šç¡®ä¿é”™è¯¯çŠ¶æ€æ¸…æ™°
- è¯¦ç»†æ—¥å¿—è®°å½•ï¼šä¾¿äºé—®é¢˜è¯Šæ–­

## 12. æ€»ç»“

SPMIDæ•°æ®åˆ†æç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œé€šè¿‡ä¸¥æ ¼çš„æ•°æ®è¿‡æ»¤ã€æ™ºèƒ½çš„åŒ¹é…ç®—æ³•ã€å…¨é¢çš„å¼‚å¸¸æ£€æµ‹å’Œç²¾ç¡®çš„ç»Ÿè®¡åˆ†æï¼Œç¡®ä¿æœ€ç»ˆç»“æœçš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚

**æ ¸å¿ƒåˆ›æ–°**ï¼š

1. **åŠ¨æ€é˜ˆå€¼åŒ¹é…**ï¼šæ ¹æ®éŸ³ç¬¦ç‰¹æ€§è‡ªé€‚åº”è°ƒæ•´åŒ¹é…å®¹é”™èŒƒå›´
2. **ä¸€å¯¹ä¸€çº¦æŸ**ï¼šç¡®ä¿åŒ¹é…ç»“æœçš„å”¯ä¸€æ€§å’Œä¸€è‡´æ€§
3. **å•ä½ä¸€è‡´æ€§**ï¼šå†…éƒ¨0.1mså•ä½ï¼ŒUIå±‚msæ˜¾ç¤ºï¼Œé¿å…ç²¾åº¦æŸå¤±
4. **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„åŒ¹é…è¿‡ç¨‹è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œåˆ†æ

**ç³»ç»Ÿç‰¹ç‚¹**ï¼š

- é«˜å‡†ç¡®æ€§ï¼šå¤šå±‚éªŒè¯ç¡®ä¿æ•°æ®è´¨é‡
- é«˜æ€§èƒ½ï¼šä¼˜åŒ–çš„ç®—æ³•å’Œæ•°æ®ç»“æ„
- é«˜å¯ç»´æŠ¤æ€§ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†å’Œæ¥å£è®¾è®¡
- é«˜å¯æ‰©å±•æ€§ï¼šçµæ´»çš„é…ç½®å’Œæ’ä»¶æœºåˆ¶

è¯¥ç³»ç»Ÿä¸ºé’¢ç´æ•°æ®åˆ†æå’Œæ€§èƒ½è¯„ä¼°æä¾›äº†å®Œæ•´ã€å¯é çš„è§£å†³æ–¹æ¡ˆã€‚
