# 按键-力度交互效应图 - 按键选择（下拉菜单方案）

## 最终方案

### UI设计
在图表标题栏添加**按键选择下拉菜单**：
```
[按键-力度交互效应图]           [下拉菜单: 选择按键（留空显示全部）▼]
+------------------------------------------------------------------+
|                                                                  |
|     散点图区域                                                     |
|                                                                  |
+------------------------------------------------------------------+
```

### 功能
1. **下拉菜单自动填充**：根据当前数据中的按键ID自动生成选项
2. **选择按键**：从下拉菜单选择一个按键 → 只显示该按键的数据点
3. **显示全部**：清空下拉菜单（或选择"全部"）→ 显示所有按键
4. **算法图注**：图例中仍保留算法控制，可以选择显示哪些算法

## 实现细节

### 1. UI组件（`ui/layout_components.py`）
```python
dbc.Row([
    dbc.Col([
        html.H6("按键-力度交互效应图", ...),
    ], width=8),
    dbc.Col([
        dcc.Dropdown(
            id='key-force-interaction-key-selector',
            placeholder='选择按键（留空显示全部）',
            clearable=True,
            style={'fontSize': '12px'}
        )
    ], width=4)
])
```

### 2. 回调逻辑（`ui/callbacks.py`）

#### 回调1：更新下拉菜单选项
```python
@app.callback(
    Output('key-force-interaction-key-selector', 'options'),
    [Input('key-force-interaction-plot', 'figure')]
)
def update_key_selector_options(figure):
    # 从figure的data中提取所有按键ID
    # legendgroup格式：data_算法名_key_按键ID
    # 返回：[{'label': '按键 16', 'value': 16}, ...]
```

#### 回调2：下拉菜单选择 → 更新 selected_keys
```python
@app.callback(
    Output('key-force-interaction-selected-keys', 'data'),
    [Input('key-force-interaction-key-selector', 'value')]
)
def update_selected_keys_from_dropdown(selected_key):
    if selected_key is None:
        return []  # 显示全部
    return [selected_key]  # 只显示选中的按键
```

#### 回调3：更新图表可见性（保持不变）
```python
@app.callback(
    Output('key-force-interaction-plot', 'figure'),
    [Input('report-content', 'children'),
     Input('key-force-interaction-selected-algorithms', 'data'),
     Input('key-force-interaction-selected-keys', 'data')]
)
def handle_generate_key_force_interaction_plot(...):
    # 根据 selected_algorithms 和 selected_keys 更新数据点可见性
```

### 3. 绘图逻辑（`backend/plot_generator.py`）

移除按键控制图注：
```python
# 只创建算法控制图注
self._create_algorithm_control_legends(fig, algorithm_display_names, algorithm_colors)
# 不再创建按键控制图注
```

算法控制图注使用空数组（只在图例显示）：
```python
fig.add_trace(go.Scatter(
    x=[],  # 空数组，不绘制点
    y=[],
    name=algorithm_name,
    marker=dict(size=12, color=algorithm_color, opacity=0.6),
    showlegend=True
))
```

## 使用场景

### 场景1：查看所有按键
1. **下拉菜单保持空白**
2. **结果**：显示所有按键的数据点（不同算法用不同颜色）

### 场景2：查看单个按键
1. **从下拉菜单选择"按键 16"**
2. **结果**：只显示按键16的数据点
   - 如果有多个算法，会同时显示所有算法中按键16的数据
   - pid算法的按键16：蓝色点
   - smc算法的按键16：橙色点

### 场景3：查看特定算法的特定按键
1. **点击图例中的"pid"算法**（选中）
2. **从下拉菜单选择"按键 16"**
3. **结果**：只显示pid算法中按键16的数据点

### 场景4：切换按键
1. 当前选择"按键 16"
2. **从下拉菜单改选"按键 21"**
3. **结果**：自动切换到按键21

### 场景5：取消按键选择
1. 当前选择"按键 16"
2. **点击下拉菜单的清除按钮（×）**
3. **结果**：显示所有按键

## 优点

1. ✅ **清晰直观**：下拉菜单比图例点击更明确
2. ✅ **不占空间**：没有多余的控制图注点
3. ✅ **易于发现**：按键选项就在图表标题旁边
4. ✅ **支持搜索**：下拉菜单可以输入按键ID快速查找
5. ✅ **可扩展**：按键很多时，下拉菜单比图例更易用

## 数据流程

```
1. 用户从下拉菜单选择"按键 16"
   ↓
2. 触发 update_selected_keys_from_dropdown
   → selected_keys = [16]
   ↓
3. selected_keys 变化触发 handle_generate_key_force_interaction_plot
   → 更新图表数据点可见性
   ↓
4. trace_belongs_to_algorithm_and_key 检查每个数据点
   → key_match = (16 in [16]) = True
   → 只有按键16的数据点可见
   ↓
5. 图表更新，只显示按键16的数据点
```

## 注意事项

1. **下拉菜单自动更新**：当数据变化时，选项会自动更新
2. **默认显示全部**：初始状态下拉菜单为空，显示所有按键
3. **算法图例保留**：仍可通过点击图例控制显示哪些算法
4. **单选模式**：下拉菜单只能选一个按键（如需多选可改为 multi=True）

