# 曲线对齐对比使用说明

## 一、概述

为了帮助用户观测DTW对齐的效果，系统提供了对齐前后对比功能。可以直观地看到：
- 对齐前：两条曲线在原始时间轴上的位置
- 对齐后：两条曲线在DTW对齐后的时间轴上的位置
- 峰值点对应关系的变化

---

## 二、使用方法

### 2.1 基本使用

```python
from backend.force_curve_analyzer import ForceCurveAnalyzer

# 创建分析器
analyzer = ForceCurveAnalyzer(
    smooth_sigma=1.0,
    dtw_distance_metric='manhattan',
    dtw_window_size_ratio=0.5
)

# 对比两条曲线
result = analyzer.compare_curves(note1, note2)

if result and 'alignment_comparison' in result:
    # 生成对齐前后对比图
    fig = analyzer.visualize_alignment_comparison(result)
    
    if fig:
        # 显示图表（在Jupyter Notebook中）
        fig.show()
        
        # 或者保存为HTML文件
        fig.write_html('alignment_comparison.html')
```

### 2.2 访问对齐前后数据

```python
# 获取对齐前后的数据
alignment_comp = result['alignment_comparison']

# 对齐前的数据
before = alignment_comp['before_alignment']
times1_before = before['times1']  # 归一化时间 [0, 1]
values1_before = before['values1']  # 曲线1的值
times2_before = before['times2']  # 归一化时间 [0, 1]
values2_before = before['values2']  # 曲线2的值

# 对齐后的数据
after = alignment_comp['after_alignment']
times_after = after['times']  # 对齐后的归一化时间 [0, 1]
values1_after = after['values1']  # 对齐后的曲线1的值
values2_after = after['values2']  # 对齐后的曲线2的值

# 峰值信息
peak_info = alignment_comp['peak_info']
before_peaks = peak_info['before']  # 对齐前的峰值索引和时间
after_peaks = peak_info['after']    # 对齐后的峰值索引
```

---

## 三、对比图说明

### 3.1 图表结构

对比图包含两个子图：

1. **上子图：对齐前（原始时间轴）**
   - 显示两条曲线在原始时间轴上的位置
   - 标记原始峰值点（菱形标记）
   - 可以观察到峰值点可能不对应

2. **下子图：对齐后（DTW对齐后的时间轴）**
   - 显示两条曲线在DTW对齐后的时间轴上的位置
   - 标记对齐后的峰值点（菱形标记）
   - 标记分割点（红色X，用于提取上升沿和下降沿）
   - 可以观察到峰值点已经对应

### 3.2 关键观察点

1. **峰值点对应关系**
   - 对齐前：两个峰值点可能在不同位置
   - 对齐后：两个峰值点应该更接近（通过DTW对齐）

2. **曲线形状对齐**
   - 对齐前：曲线可能因为时间扭曲而不对齐
   - 对齐后：曲线应该更好地对齐（特别是相似的特征点）

3. **分割点位置**
   - 红色X标记表示用于提取上升沿和下降沿的分割点
   - 分割点基于对齐后的峰值点确定

---

## 四、数据字段说明

### 4.1 `alignment_comparison` 字段

```python
{
    'before_alignment': {
        'times1': np.ndarray,      # 曲线1的归一化时间 [0, 1]
        'values1': np.ndarray,     # 曲线1的值
        'times2': np.ndarray,      # 曲线2的归一化时间 [0, 1]
        'values2': np.ndarray,     # 曲线2的值
        'original_times1': np.ndarray,  # 曲线1的原始时间（ms）
        'original_times2': np.ndarray   # 曲线2的原始时间（ms）
    },
    'after_alignment': {
        'times': np.ndarray,       # 对齐后的归一化时间 [0, 1]
        'values1': np.ndarray,     # 对齐后的曲线1的值
        'values2': np.ndarray      # 对齐后的曲线2的值
    },
    'peak_info': {
        'before': {
            'peak_idx1': int,      # 曲线1的原始峰值索引
            'peak_idx2': int,      # 曲线2的原始峰值索引
            'peak_time1': float,   # 曲线1的原始峰值时间（ms）
            'peak_time2': float    # 曲线2的原始峰值时间（ms）
        },
        'after': {
            'peak_idx1': int,      # 曲线1在对齐后的峰值索引
            'peak_idx2': int,      # 曲线2在对齐后的峰值索引
            'split_idx': int       # 用于分割上升沿/下降沿的索引
        }
    }
}
```

---

## 五、示例：完整流程

```python
from backend.force_curve_analyzer import ForceCurveAnalyzer

# 1. 创建分析器
analyzer = ForceCurveAnalyzer(
    smooth_sigma=1.0,
    dtw_distance_metric='manhattan',
    dtw_window_size_ratio=0.5
)

# 2. 对比两条曲线
result = analyzer.compare_curves(record_note, replay_note)

if result:
    # 3. 打印相似度结果
    print(f"上升沿相似度: {result['rising_edge_similarity']:.3f}")
    print(f"下降沿相似度: {result['falling_edge_similarity']:.3f}")
    print(f"整体相似度: {result['overall_similarity']:.3f}")
    print(f"DTW距离: {result['dtw_distance']:.3f}")
    
    # 4. 生成对齐前后对比图
    if 'alignment_comparison' in result:
        fig = analyzer.visualize_alignment_comparison(result)
        
        if fig:
            # 显示图表
            fig.show()
            
            # 或者保存为文件
            fig.write_html('alignment_comparison.html')
            print("✅ 对齐对比图已保存为 alignment_comparison.html")
        
        # 5. 分析峰值点对应关系
        peak_info = result['alignment_comparison']['peak_info']
        before = peak_info['before']
        after = peak_info['after']
        
        print("\n峰值点对应关系：")
        print(f"对齐前 - 曲线1峰值索引: {before['peak_idx1']}, 时间: {before['peak_time1']:.2f}ms")
        print(f"对齐前 - 曲线2峰值索引: {before['peak_idx2']}, 时间: {before['peak_time2']:.2f}ms")
        print(f"对齐后 - 曲线1峰值索引: {after['peak_idx1']}")
        print(f"对齐后 - 曲线2峰值索引: {after['peak_idx2']}")
        print(f"分割点索引: {after['split_idx']}")
```

---

## 六、注意事项

1. **时间归一化**
   - 对齐前后的时间都归一化到[0, 1]范围，便于对比
   - 原始时间保存在`before_alignment['original_times1']`和`original_times2`中

2. **峰值点索引**
   - 对齐前的峰值索引是相对于原始曲线的
   - 对齐后的峰值索引是相对于对齐后的曲线的
   - 两者不能直接比较，需要通过时间轴对应关系来理解

3. **可视化方法**
   - `visualize_alignment_comparison()`方法返回Plotly图表对象
   - 可以在Jupyter Notebook中直接显示
   - 也可以保存为HTML文件在浏览器中查看

4. **数据可用性**
   - 只有在使用新方法（`full_curve_then_edges`）时才会有`alignment_comparison`数据
   - 如果回退到旧方法，则不会有此数据

---

## 七、总结

通过对齐前后对比功能，您可以：

1. ✅ **直观观察对齐效果**：看到DTW对齐如何改善曲线的对应关系
2. ✅ **验证峰值点对应**：确认对齐后峰值点是否对应
3. ✅ **理解对齐过程**：了解DTW如何调整时间轴
4. ✅ **调试对齐参数**：通过对比图调整平滑参数、DTW窗口大小等

这对于理解曲线对齐算法和优化参数非常有用！

