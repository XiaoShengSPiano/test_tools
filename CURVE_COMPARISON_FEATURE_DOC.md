# 钢琴力度曲线对比分析功能文档

## 目录
- [概述](#概述)
- [功能架构](#功能架构)
- [核心算法](#核心算法)
- [数据处理流程](#数据处理流程)
- [可视化系统](#可视化系统)
- [用户交互流程](#用户交互流程)
- [技术实现细节](#技术实现细节)
- [性能优化](#性能优化)
- [使用示例](#使用示例)
- [故障排除](#故障排除)
- [API参考](#api参考)
- [版本历史](#版本历史)

## 概述

### 功能简介
钢琴力度曲线对比分析是钢琴演奏技术分析系统的核心功能模块，通过先进的信号处理和机器学习算法，对比录制曲线与播放曲线的力度变化特征，为演奏技术评估、教学辅助和设备性能分析提供科学依据。

### 核心价值
- **精准对齐**：基于导数的动态时间规整算法，确保曲线特征点精确对应
- **多维度分析**：同时分析整体相似度和局部特征（上升沿/下降沿）相似度
- **可视化展示**：多阶段处理过程的可视化，帮助理解分析逻辑
- **实时交互**：点击触发分析，结果即时展示

### 主要特性
- ✅ 基于导数的DTW曲线对齐算法
- ✅ 上升沿和下降沿特征提取
- ✅ 多阶段处理过程可视化
- ✅ 相似度量化评估
- ✅ 交互式瀑布图集成
- ✅ 自适应图表布局
- ✅ 滚动浏览支持

## 功能架构

### 系统架构图
```
┌─────────────────────────────────────────────────┐
│                用户界面层                        │
│  ┌─────────────────────────────────────────────┐ │
│  │            瀑布图点击触发                    │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────┐
│                业务逻辑层                        │
│  ┌─────────────────────────────────────────────┐ │
│  │        ForceCurveAnalyzer                  │ │
│  │  ├─ DerivativeDTWAligner                  │ │
│  │  ├─ CurveFeatureExtractor                 │ │
│  │  └─ SimilarityCalculator                  │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────┐
│                数据处理层                        │
│  ┌─────────────────────────────────────────────┐ │
│  │        SPMID数据解析                        │ │
│  │  ├─ After-touch曲线提取                    │ │
│  │  ├─ 时间轴转换                             │ │
│  │  └─ 数据验证与预处理                       │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 核心组件说明

#### ForceCurveAnalyzer（力度曲线分析器）
- **职责**：封装完整的曲线对比分析流程
- **输入**：两个音符对象（录制和播放）
- **输出**：相似度指标和处理阶段数据
- **方法**：
  - `compare_curves()`：执行对比分析
  - `visualize_all_processing_stages()`：生成可视化图表

#### DerivativeDTWAligner（基于导数的DTW对齐器）
- **职责**：实现基于导数的曲线对齐算法
- **核心思想**：对齐曲线的变化趋势而非绝对值
- **优势**：对噪声更鲁棒，对齐结果更符合演奏特征

#### 可视化引擎
- **技术栈**：Plotly + Dash
- **布局策略**：自适应多子图布局
- **交互特性**：滚动缩放、悬停信息

## 核心算法

### 基于导数的DTW对齐算法

#### 算法原理
传统DTW算法直接对齐曲线的值序列，而基于导数的DTW算法对齐的是曲线的导数（斜率）序列。这种方法更符合钢琴按键的物理特性：

1. **物理意义**：导数反映了按键的速度变化，更能体现演奏者的控制意图
2. **噪声鲁棒性**：小幅抖动在导数上的影响相对较小
3. **特征保持**：更好地保持上升沿和下降沿的特征

#### 算法流程

##### 1. 数据预处理
```
原始曲线 → 平滑处理 → 导数计算 → 归一化 → DTW对齐
```

**平滑处理策略**：
- 优先使用Savitzky-Golay滤波器（保持形状特征）
- 窗口大小自适应：根据数据长度动态调整
- 回退策略：当Savitzky-Golay失败时使用高斯滤波

**导数计算**：
- 使用中心差分法计算数值导数
- 时间轴保持原始分辨率
- 处理边界条件避免边缘效应

##### 2. DTW对齐过程
```
导数序列1 ↔ 导数序列2 → 距离矩阵 → 动态规划 → 最优路径 → 重新采样
```

**距离度量**：
- 曼哈顿距离（推荐）：对异常值更鲁棒
- 欧式距离：标准选择
- 切比雪夫距离：关注最大差异

**路径约束**：
- 窗口大小限制：防止过度扭曲
- 斜率约束：保持时间顺序
- 边界条件：确保起点和终点对齐

##### 3. 后处理
```
对齐路径 → 插值重采样 → 特征点映射 → 曲线分割
```

#### 算法参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| `smooth_sigma` | 1.0 | 0.1-3.0 | 高斯平滑标准差 |
| `distance_metric` | 'manhattan' | - | DTW距离度量方式 |
| `window_size_ratio` | 0.5 | 0.1-1.0 | 对齐窗口比例 |

### 曲线特征提取算法

#### 峰值检测策略
采用多层次特征检测方法：

1. **简单峰值检测**：基于scipy.signal.find_peaks
2. **高级特征检测**：结合导数分析和形态学特征
3. **自适应阈值**：根据曲线动态范围调整检测参数

#### 曲线分割逻辑
```
完整曲线 → 特征点检测 → 片段分割 → 类型判断 → 特征提取
```

**分割规则**：
- 以峰值为分割点
- 忽略过短片段（< 3个采样点）
- 根据起点终点值差判断上升/下降沿

### 相似度计算方法

#### 多维度相似度指标
- **整体相似度**：基于对齐后曲线的综合相似性
- **上升沿相似度**：专门分析按键下压过程
- **下降沿相似度**：专门分析按键释放过程
- **DTW距离**：量化对齐的难度程度

#### 计算公式
```
相似度 = 1 - (平均绝对差异 / 最大可能差异)
DTW距离 = 累积距离 / 对齐路径长度
```

## 数据处理流程

### 完整分析流程图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   数据输入   │ -> │  预处理阶段  │ -> │  对齐阶段   │
│  音符对象    │    │  平滑+导数   │    │  DTW对齐    │
└─────────────┘    └─────────────┘    └─────────────┘
                                                       │
                                                       ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 特征提取阶段 │ -> │  分割阶段   │ -> │  计算阶段   │
│  峰值检测    │    │  上升/下降  │    │  相似度     │
└─────────────┘    └─────────────┘    └─────────────┘
                                                       │
                                                       ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 可视化阶段   │ -> │  交互展示   │ -> │  用户反馈   │
│  多阶段图表  │    │  Tabs界面   │    │  结果解读   │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 详细处理步骤

#### 步骤1：数据提取
**输入**：SPMID音符对象
**处理**：
- 提取after_touch数据序列
- 转换为时间-力度值对
- 时间轴转换（0.1ms单位到毫秒）
- 数据完整性验证

**输出**：标准化后的曲线数据

#### 步骤2：曲线预处理
**平滑处理**：
- Savitzky-Golay滤波器（多项式拟合）
- 高斯滤波器（作为备选方案）
- 自适应窗口大小选择

**导数计算**：
- 数值导数计算
- 边界处理
- 异常值过滤

**归一化**：
- 导数序列归一化
- 保持相对变化特征

#### 步骤3：动态对齐
**DTW矩阵计算**：
- 距离矩阵构建
- 路径约束应用
- 最优路径搜索

**曲线重采样**：
- 根据对齐路径插值
- 时间轴同步
- 数据点密度保持

#### 步骤4：特征分析
**峰值检测**：
- 多尺度峰值识别
- 噪声过滤
- 特征点验证

**曲线分割**：
- 基于峰值分割
- 片段分类（上升/下降）
- 无效片段过滤

#### 步骤5：相似度评估
**整体相似度**：
- 对齐后曲线对比
- 多指标综合计算
- 置信度评估

**局部相似度**：
- 上升沿专项分析
- 下降沿专项分析
- 差异分布统计

## 可视化系统

### 多阶段图表架构

#### 图表布局设计
```
┌─────────────────────────────────────────┐
│ 图例区域 (Legend) - 水平排列          │
├─────────────────────────────────────────┤
│ 阶段1：原始曲线                        │
├─────────────────────────────────────────┤
│ 阶段2：平滑后的曲线                    │
├─────────────────────────────────────────┤
│ 阶段3：导数曲线                        │
├─────────────────────────────────────────┤
│ 阶段4a：对齐前对比                     │
├─────────────────────────────────────────┤
│ 阶段4b：对齐后对比 (相似度: XX%)       │
├─────────────────────────────────────────┤
│ 阶段5a：上升沿                         │
├─────────────────────────────────────────┤
│ 阶段5b：下降沿                         │
└─────────────────────────────────────────┘
```

#### 布局参数优化
- **垂直间距**：0.03（紧凑但清晰）
- **子图高度**：自适应容器高度
- **图例位置**：顶部水平排列
- **颜色方案**：蓝色（录制）+ 红色虚线（播放）

### 交互式特性

#### 图表配置
```javascript
config: {
  scrollZoom: true,      // 滚轮缩放
  displayModeBar: true,  // 显示工具栏
  responsive: true,      // 响应式调整
  displaylogo: false     // 隐藏Plotly logo
}
```

#### 悬停信息
- 显示精确的时间和力度值
- 曲线标识（录制/播放）
- 相对位置信息

### 响应式布局

#### 容器自适应
- **宽度**：自动占满容器宽度
- **高度**：动态计算（500px × 子图数量）
- **滚动**：超出视口时启用垂直滚动

#### Tabs界面设计
```
模态框
├── 标签页导航
│   ├── 曲线对比 (默认激活)
│   └── 处理全过程
│
├── 内容区域
│   ├── 曲线对比：单图展示
│   └── 处理全过程：多子图滚动展示
│
└── 操作按钮
    ├── 跳转到瀑布图
    └── 关闭
```

## 用户交互流程

### 触发条件
1. **数据准备**：系统已加载录制和播放数据
2. **视图状态**：瀑布图已渲染并显示数据
3. **用户操作**：点击瀑布图上的任意数据点

### 处理流程

#### 1. 点击检测
```
用户点击 → 坐标解析 → 数据点识别 → 音符匹配
```

**坐标解析**：
- 时间轴坐标转换
- 按键ID映射
- 数据类型判断（录制/播放）

**音符匹配**：
- 时间范围匹配
- 按键ID匹配
- 匹配对验证

#### 2. 分析执行
```
数据提取 → 曲线对比 → 相似度计算 → 可视化生成
```

**并行处理**：
- 传统SPMID图表生成
- 力度曲线分析（异步）
- 多算法对比（如果启用）

#### 3. 结果展示
```
模态框弹出 → Tabs界面 → 双视图展示
```

**界面响应**：
- 模态框渐显动画
- Tabs自动切换到活跃状态
- 图表自适应渲染

### 交互特性

#### 标签页切换
- **曲线对比**：直观展示两条曲线的差异
- **处理全过程**：详细展示6个分析阶段
- **状态保持**：切换时保持缩放和平移状态

#### 滚动浏览
- **垂直滚动**：处理全过程支持长图表浏览
- **同步缩放**：两个标签页的缩放状态独立
- **位置记忆**：关闭后重新打开时保持浏览位置

## 技术实现细节

### 数据结构设计

#### 对比结果数据结构
```python
ComparisonResult = {
    # 相似度指标
    'overall_similarity': float,      # 整体相似度 (0-1)
    'rising_edge_similarity': float,  # 上升沿相似度 (0-1)
    'falling_edge_similarity': float, # 下降沿相似度 (0-1)
    'dtw_distance': float,            # DTW距离
    
    # 差异统计
    'rising_edge_diff': dict,        # 上升沿差异统计
    'falling_edge_diff': dict,       # 下降沿差异统计
    
    # 处理阶段数据
    'processing_stages': {
        'stage1_original': dict,     # 原始曲线
        'stage2_smoothed': dict,     # 平滑曲线
        'stage3_derivatives': dict,  # 导数曲线
        'stage4_aligned': dict,      # 对齐曲线
        'stage5_edges': dict         # 边缘特征
    }
}
```

#### 可视化配置
```python
PlotConfig = {
    'layout': {
        'autosize': True,
        'showlegend': True,
        'legend': {
            'orientation': 'h',
            'yanchor': 'bottom',
            'y': 1.02,
            'xanchor': 'right',
            'x': 1
        },
        'margin': {'l': 60, 'r': 30, 't': 80, 'b': 60}
    },
    'subplot_config': {
        'vertical_spacing': 0.03,
        'row_heights': [1.0] * num_subplots
    }
}
```

### 异常处理机制

#### 数据验证
- **输入校验**：检查音符对象有效性
- **数据完整性**：验证after_touch数据存在
- **维度匹配**：确保时间和值数组长度一致
- **数值合理性**：检查数据范围和异常值

#### 算法容错
- **DTW失败**：回退到简单峰值对齐
- **特征检测失败**：使用默认分割策略
- **可视化失败**：提供错误提示信息

#### 用户反馈
- **加载状态**：显示分析进度
- **错误提示**：清晰的错误信息展示
- **降级体验**：部分功能失败时仍能展示基础结果

### 性能优化

#### 算法优化
- **增量计算**：避免重复计算
- **缓存机制**：相似结果缓存
- **并行处理**：多算法对比并行执行

#### 内存管理
- **数据清理**：及时释放临时数据
- **流式处理**：大数据集的分块处理
- **对象复用**：重用分析器实例

#### 渲染优化
- **延迟加载**：可视化数据按需生成
- **图表压缩**：优化Plotly图表大小
- **分页渲染**：大量数据点的分页展示

## 性能优化

### 时间复杂度分析

#### DTW算法复杂度
- **空间复杂度**：O(M×N)，M和N为序列长度
- **时间复杂度**：O(M×N×W)，W为窗口大小
- **实际性能**：对于典型钢琴曲线（几千个点），处理时间<1秒

#### 优化策略
- **窗口约束**：限制DTW搜索范围，减少计算量
- **采样优化**：对长序列进行降采样预处理
- **并行加速**：利用多核CPU并行计算距离矩阵

### 内存使用优化

#### 数据结构优化
- **NumPy数组**：使用内存高效的数组结构
- **就地操作**：避免不必要的数据拷贝
- **垃圾回收**：及时清理临时变量

#### 缓存策略
- **结果缓存**：相同输入的分析结果缓存
- **图表缓存**：生成的可视化结果缓存
- **LRU淘汰**：最近最少使用的缓存淘汰策略

### 用户体验优化

#### 响应时间目标
- **点击响应**：<200ms显示模态框
- **分析完成**：<2秒显示完整结果
- **图表渲染**：<500ms完成绘制

#### 渐进式加载
- **基础展示**：优先显示曲线对比结果
- **详细分析**：后台异步生成处理全过程图表
- **流式更新**：分析结果逐步展示

## 使用示例

### 基本使用流程

#### 1. 数据准备
```python
# 上传录制和播放数据文件
backend.upload_file(record_file, filename="record.mid")
backend.upload_file(replay_file, filename="replay.mid")

# 执行分析
backend.analyze_data()
```

#### 2. 触发分析
```python
# 用户在瀑布图上点击数据点
# 系统自动执行：
comparison_result = backend.force_curve_analyzer.compare_curves(
    record_note, replay_note
)

# 生成可视化
figure = backend.force_curve_analyzer.visualize_all_processing_stages(
    comparison_result
)
```

#### 3. 结果解读
```python
# 查看相似度指标
print(f"整体相似度: {comparison_result['overall_similarity']:.1%}")
print(f"上升沿相似度: {comparison_result['rising_edge_similarity']:.1%}")
print(f"下降沿相似度: {comparison_result['falling_edge_similarity']:.1%}")

# 处理阶段数据
stages = comparison_result['processing_stages']
# stage1_original, stage2_smoothed, etc.
```

### 高级配置

#### 自定义对齐参数
```python
from backend.force_curve_analyzer import DerivativeDTWAligner

# 创建自定义对齐器
aligner = DerivativeDTWAligner(
    smooth_sigma=2.0,           # 更强的平滑
    distance_metric='euclidean', # 使用欧式距离
    window_size_ratio=0.3        # 更严格的窗口约束
)

# 使用自定义对齐器
analyzer = ForceCurveAnalyzer(aligner)
```

#### 批量分析
```python
# 分析多个音符对
results = []
for record_note, replay_note in note_pairs:
    result = analyzer.compare_curves(record_note, replay_note)
    results.append(result)

# 生成综合报告
report = generate_batch_report(results)
```

## 故障排除

### 常见问题

#### 1. 分析失败
**现象**：点击数据点后无响应或显示错误
**原因**：
- 数据不完整：缺少after_touch数据
- 音符匹配失败：录制和播放数据未正确配对
- 内存不足：大数据集处理失败

**解决方案**：
- 检查数据文件完整性
- 重新执行数据配对
- 增加系统内存或减少数据量

#### 2. 图表显示异常
**现象**：图表空白、布局错乱或渲染失败
**原因**：
- Plotly版本兼容性问题
- 浏览器不支持WebGL
- 数据格式异常

**解决方案**：
- 更新Plotly到最新版本
- 检查浏览器兼容性
- 验证数据格式正确性

#### 3. 性能问题
**现象**：分析过程缓慢或界面卡顿
**原因**：
- 数据集过大
- 算法参数设置不当
- 系统资源不足

**解决方案**：
- 减少分析的数据量
- 调整算法参数（增加窗口约束）
- 升级硬件配置

### 调试信息

#### 日志分析
系统会记录详细的处理日志：
```
[INFO] 开始曲线对比分析
[DEBUG] 数据提取完成: 1500个采样点
[DEBUG] DTW对齐完成: 距离=0.123
[DEBUG] 相似度计算: 整体=85.6%, 上升沿=82.3%, 下降沿=88.9%
[INFO] 可视化生成完成
```

#### 性能监控
关键性能指标：
- 数据提取时间：<100ms
- DTW对齐时间：<500ms
- 可视化生成时间：<200ms
- 总处理时间：<1s

## API参考

### ForceCurveAnalyzer类

#### 方法

##### `compare_curves(note1, note2, record_note=None, replay_note=None)`
对比两条力度曲线

**参数**：
- `note1`, `note2`: 音符对象
- `record_note`: 录制音符（可选，用于标签）
- `replay_note`: 播放音符（可选，用于标签）

**返回值**：对比结果字典

##### `visualize_all_processing_stages(comparison_result)`
生成多阶段处理可视化

**参数**：
- `comparison_result`: compare_curves的返回值

**返回值**：Plotly Figure对象

### DerivativeDTWAligner类

#### 方法

##### `align_full_curves(curve1, curve2)`
执行基于导数的DTW对齐

**参数**：
- `curve1`: (times, values) 元组
- `curve2`: (times, values) 元组

**返回值**：对齐结果字典

##### `_compute_derivative(times, values)`
计算数值导数

**参数**：
- `times`: 时间序列
- `values`: 值序列

**返回值**：导数序列

## 版本历史

### v2.1.0 (当前版本)
- ✅ 新增基于导数的DTW对齐算法
- ✅ 实现上升沿和下降沿分别分析
- ✅ 添加多阶段处理可视化
- ✅ 优化图表布局和交互体验
- ✅ 支持自适应容器宽度

### v2.0.0
- ✅ 重构架构，模块化设计
- ✅ 支持多算法对比
- ✅ 改进用户界面交互

### v1.5.0
- ✅ 添加SPMID数据支持
- ✅ 实现基础曲线对比功能
- ✅ 初步可视化功能

### v1.0.0
- ✅ 初始版本发布
- ✅ 基础数据处理功能

---

*本文档详细描述了钢琴力度曲线对比分析功能的完整技术实现。如有疑问或需要进一步的技术细节，请参考源代码或联系开发团队。*

