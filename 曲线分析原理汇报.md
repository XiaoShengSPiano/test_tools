# 曲线分析原理与计算流程汇报

本文档详细说明了钢琴演奏还原度分析中曲线分析模块的核心原理、计算公式及处理流程。

## 1. 核心目标

曲线分析旨在评估自动演奏钢琴（Replay）对原始演奏（Record）的还原程度，重点关注力度曲线（Force/Velocity Curve）的形态、能量和平滑度的一致性。

## 2. 分析流程概览

整个分析过程分为三个主要阶段：

1. **数据提取与预处理**：从原始 SPMID 数据中提取按键的 after-touch 曲线数据，并进行归一化和去噪。
2. **曲线对齐 (Curve Alignment)**：使用动态时间规整 (DTW) 算法消除时间轴上的非线性扭曲，实现波形特征的对齐。
3. **指标计算 (Metrics Calculation)**：基于对齐后的数据，计算相似度、抖动度、面积差等多维度评价指标。

---

## 3. 详细原理与公式

### 3.1 数据预处理

* **高斯平滑 (Gaussian Smoothing)**
  为了消除传感器噪声对导数计算和特征提取的干扰，首先对原始采样数据进行高斯平滑。
  
  * **公式**：
    $S(t) = G(t) * f(t)
    $
    其中 (f(t)) 是原始曲线，(G(t)) 是高斯核函数，(*) 表示卷积操作。

* **参数**：默认 `sigma = 1.0`。

* **一阶导数 (First Derivative)**
  计算曲线的斜率，更能反映按键运动的趋势（上升沿/下降沿），作为 DTW 对齐的主要特征。
  
  * **公式**：
    $f'(t) \approx \frac{f(t+1) - f(t-1)}{2\Delta t}$ 

### 3.2 曲线对齐 (DTW)

使用 **Derivative Dynamic Time Warping (DDTW)** 算法。与传统 DTW 直接比较数值不同，DDTW 比较的是曲线的导数（形状特征），能有效避免因整体幅度偏移导致的错误对齐（如 Singularity 问题）。

* **距离度量**：曼哈顿距离 (Manhattan Distance, L1 Norm)
  $dist(i, j) = |Record'(i) - Replay'(j)|$

* **累积代价矩阵**：
  $D(i, j) = dist(i, j) + \min(D(i-1, j), D(i, j-1), D(i-1, j-1))$

* **最优路径**：从矩阵终点回溯找到代价最小的路径，根据该路径将 Replay 曲线的时间轴映射到 Record 曲线的时间轴上。

### 3.3 评价指标计算

#### 1. 相似度 (Similarity Score)

衡量两条曲线形态的一致性。基于归一化后的 DTW 距离计算。

* **公式**：
  $Similarity = (1 - \frac{DTW\_Distance}{Max\_Possible\_Distance}) \times 100\%$
  *注：实际实现中常使用基于相关系数或归一化距离的变体。*

#### 2. 面积差 (Area Difference)

反映按键过程中的总能量差异（Impulse 差异）。

* **公式**：
  $Area\_Diff = \int Replay(t) dt - \int Record(t) dt \approx \sum Replay_i - \sum Record_i$
  * **正值**：Replay 总能量偏大。
  * **负值**：Replay 总能量偏小。

#### 3. 抖动度 (Jitter / Volatility)

评估曲线的平滑程度，反映机械运动的稳定性或采样噪声。

* **原理**：计算原始曲线与其平滑后曲线之间的残差的标准差。

* **公式**：
  $Jitter = \sqrt{\frac{1}{N} \sum_{i=1}^{N} (Original_i - Smoothed_i)^2}$
  
  * **指标解读**：
    * `Record Jitter` vs `Replay Jitter`
    * 若 `Replay Jitter` >> `Record Jitter`，说明回放引入了额外的震动或不稳定性。

#### 4. 峰值差异 (Peak Difference)

衡量最大力度的还原准确性。

* **公式**：
  $Peak\_Diff = \max(Replay) - \max(Record)$

#### 5. 均方根误差 (RMSE)

在时间对齐后，逐点计算两条曲线的误差。

* **公式**：
  $RMSE = \sqrt{\frac{1}{N} \sum_{i=1}^{N} (Record_i^{aligned} - Replay_i^{aligned})^2}$

---

## 4. 分析结果可视化

系统生成包含以下内容的分析图表：

1. **原始对比图**：展示未经处理的原始采样数据，直观呈现时间偏差。
2. **对齐后对比图**：展示经过 DTW 时间规整后的曲线，便于观察形态差异。
3. **指标表格**：列出上述所有量化指标，红色/绿色高亮显示差异显著的项。

## 5. 总结

该分析体系通过结合**形态特征对齐 (DDTW)** 和 **多维度量化指标**，能够客观、全面地评价自动演奏钢琴的性能，不仅能发现“像不像”（相似度），还能诊断“稳不稳”（抖动度）和“力道准不准”（面积/峰值差）。


